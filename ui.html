<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <style>
    :root {
      --header-h: 40px;
    }

    html,
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #ffffff;
      height: 100vh;
    }

    #header {
      height: var(--header-h);
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: white;
      border-bottom: 1px solid #e1e5e9;
      font-weight: 600;
    }

    #collapseToggle {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
    }

    #collapseToggle:hover {
      background: #f0f0f0;
    }

    #content {
      height: calc(100vh - var(--header-h));
      overflow: auto;
      padding: 20px;
    }

    body.collapsed #content {
      display: none;
    }

    /* Form View Styles */
    .main-title {
      font-size: 24px;
      font-weight: 700;
      color: #333;
      margin: 0 0 8px 0;
    }

    .description {
      font-size: 14px;
      color: #666;
      margin: 0 0 24px 0;
      line-height: 1.4;
    }

    .section {
      margin-bottom: 24px;
      background: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .helper-text {
      font-size: 12px;
      color: #666;
      margin-bottom: 12px;
      line-height: 1.3;
    }

    .attach-button {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #6B7280;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      color: white;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
      width: 100%;
      justify-content: center;
    }

    .attach-button:hover {
      background: #4B5563;
    }

    .attach-button.attached {
      background: #4CAF50;
    }

    .attach-button.loading {
      background: #999;
      cursor: not-allowed;
    }

    .dropdown-arrow {
      margin-left: auto;
      font-size: 12px;
      transition: transform 0.2s;
    }

    .attach-button.open .dropdown-arrow {
      transform: rotate(180deg);
    }

    .library-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }

    .library-dropdown.show {
      display: block;
    }

    .library-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }

    .library-item:last-child {
      border-bottom: none;
    }

    .library-item:hover:not(.loading):not(.no-libraries) {
      background: #f8f9fa;
    }

    .library-item.loading {
      color: #666;
      cursor: default;
      font-style: italic;
    }

    .library-item.no-libraries {
      color: #999;
      cursor: default;
      text-align: center;
      font-style: italic;
    }

    .library-name {
      font-weight: 500;
      color: #333;
    }

    .library-type {
      font-size: 12px;
      color: #666;
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 3px;
    }

    .attach-container {
      position: relative;
    }

    .checkbox-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
      cursor: pointer;
    }

    .checkbox {
      width: 16px;
      height: 16px;
      border: 2px solid #ddd;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .checkbox.checked {
      background: #007AFF;
      border-color: #007AFF;
    }

    .checkbox.checked::after {
      content: '✓';
      color: white;
      font-size: 10px;
      font-weight: bold;
    }

    .checkbox-label {
      flex: 1;
      cursor: pointer;
    }

    .option-name {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #333;
      margin-bottom: 2px;
    }

    .option-description {
      display: block;
      font-size: 12px;
      color: #666;
      line-height: 1.3;
    }

    .run-button {
      background: #007AFF;
      border: none;
      border-radius: 6px;
      padding: 12px 24px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
    }

    .run-button:hover:not(.disabled) {
      background: #0056CC;
    }

    .run-button.disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .run-button.ready {
      background: #4CAF50;
    }

    .run-button-help {
      font-size: 12px;
      color: #666;
      text-align: center;
      margin-top: 8px;
    }

    .run-button-help.ready {
      color: #4CAF50;
    }

    .validation-error {
      display: none;
      background: #ffebee;
      border: 1px solid #ffcdd2;
      border-radius: 4px;
      padding: 8px 12px;
      margin-top: 8px;
      font-size: 12px;
      color: #d32f2f;
    }

    .validation-error.show {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .validation-warning {
      display: none;
      background: #fff3e0;
      border: 1px solid #ffcc02;
      border-radius: 4px;
      padding: 8px 12px;
      margin-top: 8px;
      font-size: 12px;
      color: #f57c00;
    }

    .validation-warning.show {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* View-specific styles */
    .view-form {
      display: block;
    }

    .view-results {
      display: none;
    }

    .view-collapsed {
      display: none;
    }

    /* Results View Styles */
    .results-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e1e5e9;
    }

    .back-button {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f0f0f0;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      color: #333;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .back-button:hover {
      background: #e0e0e0;
    }

    .back-icon {
      font-size: 16px;
    }

    .results-title-section {
      flex: 1;
    }

    .results-title {
      font-size: 20px;
      font-weight: 700;
      color: #333;
      margin: 0;
    }

    .results-count {
      font-size: 14px;
      color: #666;
      margin-top: 2px;
    }

    .results-content {
      /* Content will be styled dynamically */
    }

    /* Issue card specific styles */
    .issue-card {
      background: white;
      border-radius: 8px;
      border-left: 4px solid #ff9800;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 16px;
    }

    .issue-card:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .token-select {
      flex: 1;
      padding: 8px 12px;
      border: 2px solid #007AFF;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      cursor: pointer;
    }

    .token-select:focus {
      outline: none;
      border-color: #0056CC;
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    .token-select optgroup {
      font-weight: 600;
      color: #666;
      background: #f8f9fa;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .token-select option {
      padding: 6px 8px;
      color: #333;
      font-size: 12px;
    }

    .token-select optgroup option {
      padding-left: 16px;
      font-weight: normal;
      color: #333;
      background: white;
    }

    .token-select optgroup option:hover {
      background: #f0f8ff;
    }

    .action-button {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      font-family: inherit;
    }

    .action-button.view {
      background: #f8f9fa;
      border: 1px solid #ddd;
      color: #333;
    }

    .action-button.view:hover {
      background: #e9ecef;
    }

    .action-button.update {
      background: #007AFF;
      color: white;
      font-weight: 500;
      padding: 8px 16px;
    }

    .action-button.update:hover {
      background: #0056CC;
    }

    .action-button.ignore {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
    }

    .action-button.ignore:hover {
      background: #fee2e2;
      border: 1px solid #f87171;
      color: #b91c1c;
    }

    .issues-header {
      background: #fff3e0;
      border: 1px solid #ffcc02;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .best-match-section {
      margin-bottom: 16px;
    }

    .best-match-label {
      font-size: 12px;
      color: #007AFF;
      font-weight: 500;
      margin-bottom: 8px;
    }

    /* When in results mode */
    body.results-mode .view-form {
      display: none;
    }

    body.results-mode .view-results {
      display: block;
    }

    /* When collapsed */
    body.collapsed .view-form,
    body.collapsed .view-results {
      display: none;
    }

    body.collapsed .view-collapsed {
      display: flex;
      align-items: center;
      justify-content: center;
      height: calc(100vh - var(--header-h));
      padding: 16px;
    }

    /* When minimized */
    body.minimized .view-form,
    body.minimized .view-collapsed {
      display: none;
    }

    body.minimized .view-results {
      display: block;
    }

    body.minimized .results-header {
      display: none;
    }

    body.minimized .results-content {
      padding: 0;
    }

    body.minimized .view-minimized {
      display: block;
    }

    /* Minimized View Styles */
    .view-minimized {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: white;
      border-bottom: 1px solid #e1e5e9;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .minimized-content {
      padding: 8px 12px;
      background: white;
    }

    .minimized-controls {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
    }

    .expand-button {
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #333;
      transition: all 0.2s ease;
    }

    .expand-button:hover {
      background: #e9ecef;
      border-color: #adb5bd;
    }

    /* Hide other views when minimized */
    body.minimized .view-results,
    body.minimized .view-form,
    body.minimized .view-documentation {
      display: none;
    }

    body.minimized .view-minimized {
      display: block;
    }

    .collapsed-content {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      width: 100%;
    }

    .expand-button {
      background: #007AFF;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      cursor: pointer;
      font-family: inherit;
      font-size: 14px;
      color: white;
      font-weight: 600;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
      min-width: 140px;
      text-align: center;
    }

    .expand-button:hover {
      background: #0056CC;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
    }

    /* Validation Options */
    .validation-options {
      margin-top: 20px;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e1e5e9;
    }

    .option-group {
      margin: 16px 0;
    }

    .option-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      margin-bottom: 8px;
      background: white;
      border-radius: 6px;
      border: 1px solid #e1e5e9;
      cursor: pointer;
      transition: all 0.2s;
    }

    .option-item:hover {
      border-color: #6B7280;
      background: #fafbfc;
    }

    .option-item input[type="checkbox"] {
      appearance: none;
      -webkit-appearance: none;
      margin: 0;
      width: 16px;
      height: 16px;
      border: 2px solid #ddd;
      border-radius: 3px;
      background: white;
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease;
    }

    .option-item input[type="checkbox"]:checked {
      background: #E8F5E8;
      border-color: #4CAF50;
    }

    .option-item input[type="checkbox"]:checked::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #000;
      font-size: 10px;
      font-weight: bold;
      line-height: 1;
    }

    .option-content {
      flex: 1;
    }

    .option-title {
      font-weight: 500;
      font-size: 14px;
      color: #1a1a1a;
      margin-bottom: 4px;
    }

    .option-description {
      font-size: 12px;
      color: #666;
      line-height: 1.4;
      margin-bottom: 4px;
    }

    .option-count {
      font-size: 11px;
      color: #4CAF50;
      font-weight: 500;
    }

    .run-validation-button {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #4CAF50;
      border: none;
      border-radius: 6px;
      padding: 12px 20px;
      color: white;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
      justify-content: center;
      margin-top: 16px;
    }

    .run-validation-button:hover {
      background: #45a049;
      transform: translateY(-1px);
    }

    .run-validation-button:disabled,
    .run-validation-button.disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .run-icon {
      font-size: 12px;
    }

    /* View Tokens Link */
    .view-tokens-link {
      background: none;
      border: none;
      color: #007AFF;
      font-size: 11px;
      cursor: pointer;
      text-decoration: underline;
      padding: 0;
      font-family: inherit;
    }

    .view-tokens-link:hover {
      color: #0056CC;
    }

    /* Tokens Panel */
    .tokens-panel {
      position: fixed;
      top: 0;
      right: -100%;
      width: 100%;
      height: 100vh;
      background: white;
      z-index: 2000;
      transition: right 0.3s ease;
      overflow-y: auto;
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
    }

    .tokens-panel.show {
      right: 0;
    }

    .tokens-panel-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #e1e5e9;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .tokens-back-button {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f0f0f0;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      color: #333;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tokens-back-button:hover {
      background: #e0e0e0;
    }

    .tokens-panel-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin: 0;
    }

    .tokens-panel-content {
      padding: 20px;
    }

    .token-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      margin-bottom: 8px;
      background: white;
      border: 1px solid #e1e5e9;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .token-item:hover {
      border-color: #007AFF;
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.1);
    }

    .token-info {
      flex: 1;
    }

    .token-name {
      font-size: 14px;
      font-weight: 500;
      color: #333;
      margin-bottom: 4px;
    }

    .token-description {
      font-size: 12px;
      color: #666;
    }

    .token-value {
      font-size: 14px;
      color: #007AFF;
      font-weight: 500;
      font-family: 'SF Mono', Monaco, monospace;
    }

    .tokens-empty {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    .tokens-empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    /* Token Categories */
    .token-category {
      margin-bottom: 24px;
    }

    .token-category-header {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e1e5e9;
    }

    /* Documentation Link */
    .documentation-section {
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid #e1e5e9;
      text-align: center;
    }

    .documentation-link {
      background: none;
      border: none;
      color: #007AFF;
      font-size: 14px;
      cursor: pointer;
      text-decoration: underline;
      padding: 8px 16px;
      border-radius: 6px;
      transition: all 0.2s;
      font-family: inherit;
    }

    .documentation-link:hover {
      background: #f0f8ff;
      color: #0056CC;
      text-decoration: none;
    }

    /* Documentation View */
    .view-documentation {
      display: none;
    }

    .documentation-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e1e5e9;
    }

    .documentation-title-section {
      flex: 1;
    }

    .documentation-title {
      font-size: 20px;
      font-weight: 700;
      color: #333;
      margin: 0;
    }

    .documentation-content {
      line-height: 1.6;
      color: #333;
    }

    .documentation-content h1 {
      font-size: 24px;
      font-weight: 700;
      color: #333;
      margin: 0 0 16px 0;
    }

    .documentation-content h2 {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin: 24px 0 12px 0;
    }

    .documentation-content h3 {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin: 20px 0 8px 0;
    }

    .documentation-content p {
      margin: 0 0 12px 0;
    }

    .documentation-content ul {
      margin: 0 0 12px 20px;
      padding: 0;
    }

    .documentation-content li {
      margin-bottom: 4px;
    }

    .documentation-content code {
      background: #f5f5f5;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 13px;
    }

    .documentation-content pre {
      background: #f8f9fa;
      border: 1px solid #e1e5e9;
      border-radius: 6px;
      padding: 12px;
      overflow-x: auto;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 13px;
      margin: 12px 0;
    }

    /* Tab Navigation */
    .tab-navigation {
      display: flex;
      background: #f8f9fa;
      border-bottom: 1px solid #e1e5e9;
      margin: -20px -20px 20px -20px;
      padding: 0 20px;
      overflow-x: auto;
    }

    .tab-button {
      background: none;
      border: none;
      padding: 12px 16px;
      font-size: 14px;
      color: #666;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      white-space: nowrap;
      transition: all 0.2s;
      font-family: inherit;
    }

    .tab-button:hover {
      color: #333;
      background: rgba(0, 122, 255, 0.05);
    }

    .tab-button.active {
      color: #007AFF;
      border-bottom-color: #007AFF;
      background: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* When in documentation mode */
    body.documentation-mode .view-form,
    body.documentation-mode .view-results {
      display: none;
    }

    body.documentation-mode .view-documentation {
      display: block;
    }
  </style>
</head>

<body>
  <div id="content">
    <!-- Form View -->
    <div class="view-form" id="formView">
      <h1 class="main-title">Token Validation</h1>
      <p class="description">
        Attach a design system to automatically import text styles and access design tokens.
      </p>

      <div class="section design-system-section">
        <div class="section-title">Design System:</div>
        <div class="helper-text">
          Select a design system to validate your design tokens against.
        </div>
        <div class="attach-container">
          <button class="attach-button" id="attach-design-system">
            <span id="attach-text">Attach Design System</span>
            <span class="dropdown-arrow" id="dropdown-arrow">▼</span>
          </button>
          <div class="library-dropdown" id="library-dropdown">
            <div class="library-item loading">Loading design systems...</div>
          </div>
        </div>

        <!-- Validation Options (shown after successful attachment) -->
        <div class="validation-options" id="validation-options" style="display: none;">
          <div class="section-title">Validation Options</div>
          <div class="helper-text">
            Select what you'd like to validate from your attached design system.
          </div>

          <div class="option-group">
            <label class="option-item">
              <input type="checkbox" id="validate-text-styles">
              <span class="checkmark"></span>
              <div class="option-content">
                <div class="option-title">Text Styles</div>
                <div class="option-description">Validate text styles usage from the design system</div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div class="option-count" id="text-styles-count">Loading...</div>
                  <button class="view-tokens-link" id="view-text-styles" style="display: none;"
                    onclick="showTokensPanel('text-styles')">View Tokens</button>
                </div>
              </div>
            </label>

            <label class="option-item">
              <input type="checkbox" id="validate-spacing">
              <span class="checkmark"></span>
              <div class="option-content">
                <div class="option-title">Spacing</div>
                <div class="option-description">Validate spacing tokens and layout consistency</div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div class="option-count" id="spacing-count">Loading...</div>
                  <button class="view-tokens-link" id="view-spacing" style="display: none;"
                    onclick="showTokensPanel('spacing')">View Tokens</button>
                </div>
              </div>
            </label>
          </div>

          <button class="run-validation-button" id="run-validation" disabled>
            <span class="run-icon">▶</span>
            Run Validation
          </button>
        </div>

      </div>

      <!-- Documentation Link -->
      <div class="documentation-section">
        <button class="documentation-link" id="documentation-link">
          Documentation
        </button>
      </div>

    </div>

    <!-- Results View -->
    <div class="view-results" id="resultsView">
      <div class="results-header">
        <button class="back-button" id="back-to-form">
          <span class="back-icon">←</span>
          New Check
        </button>
        <div class="results-title-section">
          <div class="results-title" id="results-title">Results</div>
        </div>
      </div>
      <div class="results-content" id="results-content">
        <!-- Results will be populated here -->
      </div>
      
      <!-- Total Errors Section -->
      <div class="total-errors-section" id="total-errors-section" style="display: none;">
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: white; border-top: 1px solid #e1e5e9; border-radius: 0 0 8px 8px;">
          <span style="font-size: 16px; color: #666; font-weight: 500;">Total Errors</span>
          <div style="background: #ff5757; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; min-width: 40px; text-align: center;" id="total-errors-count">
            0
          </div>
        </div>
      </div>
    </div>

    <!-- Minimized View -->
    <div class="view-minimized" id="minimizedView" style="display: none;">
      <div class="minimized-content" id="minimized-content">
        <!-- Minimized issue row will be populated here -->
      </div>
      <div class="minimized-controls">
        <button class="expand-button" id="expand-button" onclick="expandView()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15,3 21,3 21,9"></polyline>
            <polyline points="9,21 3,21 3,15"></polyline>
            <line x1="21" y1="3" x2="14" y2="10"></line>
            <line x1="3" y1="21" x2="10" y2="14"></line>
          </svg>
        </button>
      </div>
    </div>

    <!-- Documentation View -->
    <div class="view-documentation" id="documentationView">
      <div class="documentation-header">
        <button class="back-button" id="documentation-back-button">
          <span class="back-icon">←</span>
          Back
        </button>
        <div class="documentation-title-section">
          <div class="documentation-title">Documentation</div>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <button class="tab-button active" data-tab="overview">Overview</button>
        <button class="tab-button" data-tab="getting-started">Getting Started</button>
        <button class="tab-button" data-tab="text-styles">Text Styles</button>
        <button class="tab-button" data-tab="spacing-tokens">Spacing Tokens</button>
        <button class="tab-button" data-tab="rules-matching">Rules & Matching Logic</button>
        <button class="tab-button" data-tab="best-practices">Best Practices</button>
        <button class="tab-button" data-tab="troubleshooting">Troubleshooting</button>
      </div>

      <div class="documentation-content" id="documentationContent">
        <!-- Overview Tab -->
        <div class="tab-content active" id="overview">
          <h1>Overview</h1>
          <p>The Token Validation Tool helps teams keep typography and spacing consistent across Figma files by checking what's in your document against the design system you attach (local styles/variables or published team libraries). It scans your file, flags mismatches, and recommends replacing hard-coded values with the appropriate design tokens so you can fix issues quickly and confidently.</p>

          <h2>Why local variables matter</h2>
          <p>This tool is built around Figma local variables, which are the most reliable way to encode spacing, colors, and typography as design tokens—making them reusable, theme-able, and machine-verifiable. We provide companion plugins to create tokens as local variables and to convert existing hard-coded values into local variables. Today, the best practice—and what this tool supports—is to build your system using local variables.</p>

          <h2>What the tool validates today</h2>
          <ul>
            <li><strong>Text Styles</strong> → Finds text layers without a style, surfaces available styles, and prompts you to apply the appropriate style from the attached system.</li>
            <li><strong>Spacing Tokens</strong> → Detects hard-coded spacing (e.g., 16px) and recommends replacing it with a spacing token from your attached system's variable collections (not a guessed variable name).</li>
          </ul>

          <h2>How it works (at a glance)</h2>
          <ol>
            <li>Attach a design system (your file's local variables/styles or a published team library).</li>
            <li>The tool scans your document for text, spacing, and variable usage.</li>
            <li>It highlights inconsistencies and suggests using tokens instead of hard-coded values (e.g., replace 16px with a matching spacing token from your system).</li>
            <li>You apply corrections to align your file with the design system.</li>
          </ol>

          <h2>Who it's for</h2>
          <ul>
            <li>Designers who want fast, reliable guardrails for token usage</li>
            <li>Design-ops and system owners migrating teams to variable-based tokens</li>
            <li>Anyone auditing files before handoff to ensure token parity with the system</li>
          </ul>
          <p><strong>Note:</strong> The tool recommends using tokens and surfaces candidate matches from your attached system. It does not invent or guess new token names; creating or renaming tokens is handled by the companion creation/conversion plugins.</p>
        </div>

        <!-- Getting Started Tab -->
        <div class="tab-content" id="getting-started">
          <h1>Getting Started</h1>

          <h2>1. Attach a Design System</h2>
          <ol>
            <li>Click "Attach Design System" in the main interface</li>
            <li>Select from available design systems:
              <ul>
                <li><strong>Local Styles & Variables</strong>: Your current document's styles and variables</li>
                <li><strong>Team Libraries</strong>: Published design systems from your team</li>
              </ul>
            </li>
          </ol>

          <h2>2. Validation Options</h2>
          <p>Once a design system is attached, you'll see validation options with counts:</p>
          <ul>
            <li><strong>Text Styles</strong>: Validates text style usage (shows "X Styles Available")</li>
            <li><strong>Spacing</strong>: Validates spacing tokens and layout consistency (shows "X Variables
              Available")</li>
          </ul>
        </div>

        <!-- Text Styles Tab -->
        <div class="tab-content" id="text-styles">
          <h1>Text Style Detection</h1>

          <h2>How It Works</h2>
          <p>The tool detects text styles from attached design systems and compares them against text styles used in
            your document.</p>

          <h2>Current Implementation</h2>
          <ul>
            <li><strong>Library text styles</strong>: Automatically detected from attached design systems</li>
            <li><strong>Count display</strong>: Shows total number of available text styles (e.g., "16 Styles
              Available")</li>
            <li><strong>Usage validation</strong>: Checks which styles from the design system are actually being used
            </li>
          </ul>
        </div>

        <!-- Spacing Tokens Tab -->
        <div class="tab-content" id="spacing-tokens">
          <h1>Spacing Variable Detection</h1>

          <h2>How It Works</h2>
          <p>The tool automatically detects spacing variables by looking at <strong>collection names</strong>. It counts
            ALL variables within collections whose names contain spacing-related keywords.</p>

          <h2>Supported Collection Names (Case-Insensitive)</h2>
          <p>Collections will be detected if their name contains any of these keywords:</p>
          <ul>
            <li><code>spacing</code></li>
            <li><code>space</code></li>
            <li><code>gap</code></li>
            <li><code>margin</code></li>
            <li><code>padding</code></li>
            <li><code>size</code></li>
          </ul>

          <h2>Examples</h2>
          <h3>✅ Will be detected:</h3>
          <ul>
            <li>"Spacing"</li>
            <li>"Space"</li>
            <li>"Design Spacing"</li>
            <li>"Layout Spacing"</li>
            <li>"Spacing Tokens"</li>
            <li>"Gap"</li>
            <li>"Margins"</li>
            <li>"Padding"</li>
            <li>"Size"</li>
            <li>"Component Spacing"</li>
          </ul>

          <h3>❌ Will NOT be detected:</h3>
          <ul>
            <li>"Design Tokens"</li>
            <li>"Foundation"</li>
            <li>"Variables"</li>
            <li>"System"</li>
            <li>"Tokens"</li>
          </ul>

          <h2>What Gets Counted</h2>
          <ul>
            <li><strong>ALL variables</strong> within collections that match the naming criteria</li>
            <li>Individual variable names within those collections are <strong>not filtered</strong></li>
            <li>If a collection is named "Spacing", <strong>all variables in it</strong> count as spacing variables</li>
          </ul>
        </div>

        <!-- Rules & Matching Logic Tab -->
        <div class="tab-content" id="rules-matching">
          <h1>Validation Process</h1>

          <h2>What Gets Validated</h2>

          <h3>1. Text Style Usage:</h3>
          <ul>
            <li>Identifies text nodes using hardcoded formatting instead of design system styles</li>
            <li>Suggests appropriate text styles from the attached design system</li>
          </ul>

          <h3>2. Spacing Consistency:</h3>
          <ul>
            <li>Detects hardcoded spacing values</li>
            <li>Suggests appropriate spacing tokens from detected spacing collections</li>
          </ul>

          <h2>Validation Requirements</h2>
          <p>For validation to work properly:</p>
          <ol>
            <li><strong>Design system must be attached</strong> and contain relevant tokens</li>
            <li><strong>At least some design system tokens must be in use</strong> in your document</li>
            <li><strong>Spacing variables must be in properly named collections</strong> (see Spacing Tokens tab)</li>
          </ol>

          <h2>Console Logging</h2>
          <p>The tool provides detailed console logging to help you understand what's happening:</p>

          <h3>Spacing Detection Example</h3>
          <pre><code>📊 Getting spacing variables count for Blueprint Atoms...
📋 SPACING DETECTION: Looking for collections with names containing: spacing, space, gap, margin, padding, size
🔍 Analyzing 2 collections...
🔍 Checking collection: "Spacing" with 3 variables
✅ "Spacing" is a spacing collection with 3 variables
🔍 Checking collection: "Colors" with 12 variables
⏭️ "Colors" is not a spacing collection, skipping

📊 SPACING DETECTION SUMMARY:
   ✅ Detected spacing collections: "Spacing" (3 variables)
   ⏭️ Skipped collections: "Colors"
   📏 Total spacing variables: 3</code></pre>
        </div>

        <!-- Best Practices Tab -->
        <div class="tab-content" id="best-practices">
          <h1>Best Practices</h1>

          <h2>Organizing Variables</h2>
          <ol>
            <li><strong>Create dedicated collections</strong> for different token types:
              <ul>
                <li>"Spacing" for spacing tokens</li>
                <li>"Colors" for color tokens</li>
                <li>"Typography" for typography tokens</li>
              </ul>
            </li>
            <li><strong>Use descriptive names</strong> that include relevant keywords for automatic detection</li>
            <li><strong>Group related variables</strong> together in the same collection</li>
          </ol>

          <h2>Design System Setup</h2>
          <ol>
            <li><strong>Publish your design system</strong> as a team library for broader access</li>
            <li><strong>Use consistent naming conventions</strong> across your design tokens</li>
            <li><strong>Apply design system styles</strong> to at least some elements in your document before validation
            </li>
          </ol>

          <h2>Limitations</h2>

          <h3>Current Limitations</h3>
          <ul>
            <li><strong>Collection name dependency</strong>: Spacing detection relies on collection names containing
              specific keywords</li>
            <li><strong>Library access</strong>: Some design systems may not be accessible depending on permissions</li>
            <li><strong>Text style API</strong>: Full text style enumeration requires REST API access (currently
              simulated)</li>
          </ul>

          <h3>Future Improvements</h3>
          <ul>
            <li>Individual variable name detection (not just collection names)</li>
            <li>More flexible detection patterns</li>
            <li>Enhanced text style discovery</li>
            <li>Custom keyword configuration</li>
          </ul>
        </div>

        <!-- Troubleshooting Tab -->
        <div class="tab-content" id="troubleshooting">
          <h1>Troubleshooting</h1>

          <h2>Spacing Variables</h2>
          <p>If your spacing variables show "0 Variables Available":</p>
          <ol>
            <li><strong>Check your collection names</strong> in Figma's Variables panel</li>
            <li><strong>Ensure at least one collection name contains</strong> one of the supported keywords</li>
            <li><strong>Consider renaming</strong> your collection to include "Spacing" or "Space"</li>
            <li><strong>Alternative</strong>: Create a dedicated "Spacing" collection for your spacing variables</li>
          </ol>

          <h2>Getting Help</h2>
          <ol>
            <li><strong>Check the console</strong> for detailed logging and troubleshooting information</li>
            <li><strong>Verify your collection names</strong> match the supported patterns</li>
            <li><strong>Ensure your design system is properly published</strong> and accessible</li>
            <li><strong>Test with a simple setup</strong> first (e.g., create a "Spacing" collection with a few
              variables)</li>
          </ol>

          <h2>Common Issues</h2>

          <h3>"0 Variables Available" for spacing:</h3>
          <ul>
            <li>Check collection names contain spacing-related keywords</li>
            <li>Verify variables are in collections, not loose variables</li>
          </ul>

          <h3>"No design system usage found":</h3>
          <ul>
            <li>Apply at least one text style from the design system to your document</li>
            <li>Ensure the design system is properly attached</li>
          </ul>

          <h3>Design system not appearing:</h3>
          <ul>
            <li>Check if the library is published and you have access</li>
            <li>Try refreshing the design system list</li>
          </ul>

          <h2>Troubleshooting Output</h2>
          <pre><code>⚠️ TROUBLESHOOTING: No spacing variables detected!
   💡 To fix this, ensure at least one collection name contains:
      "spacing", "space", "gap", "margin", "padding", or "size"
   💡 Consider renaming a collection to "Spacing" or creating a dedicated spacing collection</code></pre>
        </div>
      </div>
    </div>

    <!-- Collapsed View -->
    <div class="view-collapsed" id="collapsedView">
      <div class="collapsed-content">
        <button id="expand-button" class="expand-button">
          Token Validator
        </button>
      </div>
    </div>

    <!-- Tokens Panel -->
    <div class="tokens-panel" id="tokensPanel">
      <div class="tokens-panel-header">
        <button class="tokens-back-button" id="tokensBackButton">
          <span>←</span>
          Back
        </button>
        <h2 class="tokens-panel-title" id="tokensPanelTitle">Available Tokens</h2>
      </div>
      <div class="tokens-panel-content" id="tokensPanelContent">
        <!-- Tokens will be populated here -->
      </div>
    </div>
  </div>



  <script>
    console.log('🔍 UI SCRIPT LOADING');

    // State management
    let currentView = 'form'; // 'form', 'results', 'collapsed'
    // Removed validation options - focusing only on design system attachment
    let attachedDesignSystem = null;
    let availableTokens = null; // Store the actual design tokens
    let currentDesignSystem = null; // Store the current design system with text styles

    // Get elements
    const collapseBtn = document.getElementById('collapseToggle');

    // Form elements
    const attachButton = document.getElementById('attach-design-system');
    // Removed runButton - not needed for design system focus
    const backButton = document.getElementById('back-to-form');
    const expandButton = document.getElementById('expand-button');

    // View switching functions
    function showFormView() {
      currentView = 'form';
      document.body.className = '';
      console.log('📋 Switched to Form view');
    }

    function showResultsView() {
      currentView = 'results';
      document.body.className = 'results-mode';
      console.log('📊 Switched to Results view');
    }

    function showCollapsedView() {
      currentView = 'collapsed';
      document.body.className = 'collapsed';
      console.log('🔄 Switched to Collapsed view');
    }

    function showDocumentationView() {
      currentView = 'documentation';
      document.body.className = 'documentation-mode';
      console.log('📖 Switched to Documentation view');
    }

    // Simplified - only need to track design system attachment
    function updateUI() {
      console.log('🔄 Updating UI state');
      // UI updates handled by design system attachment flow
    }

    // Removed checkbox event listeners - no validation options needed

    // Dropdown state
    let isDropdownOpen = false;
    let availableLibraries = [];
    let isLoadingLibraries = false;

    // Main action buttons
    attachButton?.addEventListener('click', (e) => {
      e.stopPropagation();
      console.log('📎 Attach design system clicked');

      if (attachedDesignSystem) {
        // If already attached, detach
        detachDesignSystem();
      } else {
        // Show dropdown to select design system
        toggleDropdown();
      }
    });

    function toggleDropdown() {
      isDropdownOpen = !isDropdownOpen;
      const dropdown = document.getElementById('library-dropdown');
      const arrow = document.getElementById('dropdown-arrow');

      if (isDropdownOpen) {
        dropdown.classList.add('show');
        attachButton.classList.add('open');

        // Load libraries if not already loaded
        if (availableLibraries.length === 0 && !isLoadingLibraries) {
          loadDesignSystems();
        }
      } else {
        dropdown.classList.remove('show');
        attachButton.classList.remove('open');
      }
    }

    function closeDropdown() {
      isDropdownOpen = false;
      const dropdown = document.getElementById('library-dropdown');
      dropdown.classList.remove('show');
      attachButton.classList.remove('open');
    }

    function loadDesignSystems() {
      isLoadingLibraries = true;
      const dropdown = document.getElementById('library-dropdown');
      dropdown.innerHTML = '<div class="library-item loading">Loading design systems...</div>';

      // Request libraries from the plugin
      parent.postMessage({
        pluginMessage: {
          type: 'get-libraries'
        }
      }, '*');
    }

    function populateDropdown(libraries) {
      const dropdown = document.getElementById('library-dropdown');
      dropdown.innerHTML = '';

      if (libraries.length === 0) {
        dropdown.innerHTML = '<div class="library-item no-libraries">No design systems found</div>';
        return;
      }

      libraries.forEach(library => {
        const item = document.createElement('div');
        item.className = 'library-item';
        item.innerHTML = `
          <span class="library-name">${library.name}</span>
          <span class="library-type">${library.source || 'Library'}</span>
        `;

        item.addEventListener('click', () => {
          selectDesignSystem(library);
        });

        dropdown.appendChild(item);
      });
    }

    function selectDesignSystem(library) {
      console.log('📎 Selected design system:', library.name);
      attachedDesignSystem = library;
      currentDesignSystem = library; // Also store for dropdown population

      // Don't update button state yet - wait for validation check
      // The button will only update to "attached" if validation is possible

      // Close dropdown
      closeDropdown();

      // Update UI state
      updateUI();

      // Notify plugin
      parent.postMessage({
        pluginMessage: {
          type: 'attach-design-system',
          libraryId: library.id
        }
      }, '*');
    }

    function detachDesignSystem() {
      console.log('📎 Detaching design system');
      attachedDesignSystem = null;
      currentDesignSystem = null;

      // Update UI
      document.getElementById('attach-text').textContent = 'Attach Design System';
      attachButton.classList.remove('attached');

      // Hide validation options
      document.getElementById('validation-options').style.display = 'none';

      // Update UI state
      updateUI();

      // Notify plugin
      parent.postMessage({
        pluginMessage: {
          type: 'detach-design-system'
        }
      }, '*');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!attachButton.contains(e.target) && !document.getElementById('library-dropdown').contains(e.target)) {
        closeDropdown();
      }
    });

    // Removed runButton event listener - focusing only on design system attachment

    backButton?.addEventListener('click', () => {
      console.log('← Back to form clicked');
      showFormView();
      parent.postMessage({ pluginMessage: { type: 'show-form-view' } }, '*');
    });

    expandButton?.addEventListener('click', () => {
      console.log('🔄 Expand clicked');
      showFormView();
      parent.postMessage({ pluginMessage: { type: 'show-form-view' } }, '*');
    });

    // Documentation functionality
    const documentationLink = document.getElementById('documentation-link');
    const documentationBackButton = document.getElementById('documentation-back-button');

    documentationLink?.addEventListener('click', () => {
      console.log('📖 Documentation link clicked');
      showDocumentationView();
      parent.postMessage({ pluginMessage: { type: 'show-documentation-view' } }, '*');
    });

    documentationBackButton?.addEventListener('click', () => {
      console.log('← Documentation back clicked');
      showFormView();
      parent.postMessage({ pluginMessage: { type: 'show-form-view' } }, '*');
    });

    // Tab navigation functionality
    function initTabNavigation() {
      const tabButtons = document.querySelectorAll('.tab-button');
      const tabContents = document.querySelectorAll('.tab-content');

      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const targetTab = button.getAttribute('data-tab');

          // Remove active class from all buttons and contents
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));

          // Add active class to clicked button and corresponding content
          button.classList.add('active');
          const targetContent = document.getElementById(targetTab);
          if (targetContent) {
            targetContent.classList.add('active');
          }

          console.log('📑 Switched to tab:', targetTab);
        });
      });
    }

    // Initialize tab navigation when DOM is loaded
    document.addEventListener('DOMContentLoaded', initTabNavigation);
    // Also initialize immediately in case DOM is already loaded
    initTabNavigation();

    // Documentation functionality
    document.getElementById('documentation-link')?.addEventListener('click', () => {
      console.log('📖 Documentation clicked');
      showDocumentationView();
      parent.postMessage({ pluginMessage: { type: 'show-documentation-view' } }, '*');
    });

    document.getElementById('documentation-back-button')?.addEventListener('click', () => {
      console.log('← Documentation back clicked');
      showFormView();
      parent.postMessage({ pluginMessage: { type: 'show-form-view' } }, '*');
    });

    // Function to update Run Validation button state
    function updateRunValidationButton() {
      const runValidationButton = document.getElementById('run-validation');
      const validateTextStyles = document.getElementById('validate-text-styles')?.checked || false;
      const validateSpacing = document.getElementById('validate-spacing')?.checked || false;

      const hasSelection = validateTextStyles || validateSpacing;

      if (runValidationButton) {
        runValidationButton.disabled = !hasSelection;
        if (hasSelection) {
          runValidationButton.classList.remove('disabled');
        } else {
          runValidationButton.classList.add('disabled');
        }
      }
    }

    // Add event listeners to checkboxes to update button state
    document.getElementById('validate-text-styles')?.addEventListener('change', updateRunValidationButton);
    document.getElementById('validate-spacing')?.addEventListener('change', updateRunValidationButton);

    // Run validation button
    const runValidationButton = document.getElementById('run-validation');
    runValidationButton?.addEventListener('click', () => {
      console.log('▶ Run validation clicked');

      // Get selected validation options
      const validateTextStyles = document.getElementById('validate-text-styles').checked;
      const validateSpacing = document.getElementById('validate-spacing').checked;

      if (!validateTextStyles && !validateSpacing) {
        alert('Please select at least one validation option.');
        return;
      }

      // Send validation request to plugin
      parent.postMessage({
        pluginMessage: {
          type: 'run-validation',
          options: {
            textStyles: validateTextStyles,
            spacing: validateSpacing
          }
        }
      }, '*');

      // Switch to results view
      showResultsView();
      parent.postMessage({ pluginMessage: { type: 'show-results-view' } }, '*');
    });

    // Initialize button state
    updateRunValidationButton();

    // Header collapse toggle
    collapseBtn?.addEventListener('click', () => {
      console.log('🔄 Collapse toggle clicked');
      parent.postMessage({ pluginMessage: { type: 'toggle-collapse' } }, '*');
    });



    // Function to fetch all published styles from a library via REST API
    async function fetchLibraryStyles(fileKey, libraryName) {
      console.log(`🚀🚀🚀 FETCHING ALL PUBLISHED STYLES FROM ${libraryName} 🚀🚀🚀`);
      console.log(`📁 File Key: ${fileKey}`);

      try {
        // Note: This requires a Figma access token
        // For demo purposes, we'll show what the response would look like
        console.log(`\n📡 REST API CALL:`);
        console.log(`   URL: https://api.figma.com/v1/files/${fileKey}`);
        console.log(`   Method: GET`);
        console.log(`   Headers: { 'Authorization': 'Bearer YOUR_FIGMA_ACCESS_TOKEN' }`);

        console.log(`\n⚠️ NOTE: This demo cannot make actual HTTP requests due to browser security.`);
        console.log(`   To see all published styles, you would need to:`);
        console.log(`   1. Get a Figma access token from https://www.figma.com/developers/api`);
        console.log(`   2. Make the API call from your server or a tool like Postman`);
        console.log(`   3. Filter response.styles for style_type === 'TEXT'`);

        console.log(`\n📋 EXPECTED RESPONSE STRUCTURE:`);
        console.log(`{`);
        console.log(`  "styles": [`);
        console.log(`    {`);
        console.log(`      "key": "style_key_here",`);
        console.log(`      "name": "Display/Large",`);
        console.log(`      "description": "Large display text",`);
        console.log(`      "style_type": "TEXT",`);
        console.log(`      "created_at": "2024-01-01T00:00:00Z",`);
        console.log(`      "updated_at": "2024-01-01T00:00:00Z"`);
        console.log(`    },`);
        console.log(`    {`);
        console.log(`      "key": "another_style_key",`);
        console.log(`      "name": "Display/Medium",`);
        console.log(`      "description": "Medium display text",`);
        console.log(`      "style_type": "TEXT"`);
        console.log(`    }`);
        console.log(`    // ... more styles`);
        console.log(`  ]`);
        console.log(`}`);

        console.log(`\n💡 JAVASCRIPT EXAMPLE TO FETCH ALL STYLES:`);
        console.log(`const response = await fetch('https://api.figma.com/v1/files/${fileKey}', {`);
        console.log(`  headers: { 'Authorization': 'Bearer YOUR_ACCESS_TOKEN' }`);
        console.log(`});`);
        console.log(`const data = await response.json();`);
        console.log(`const textStyles = data.styles.filter(s => s.style_type === 'TEXT');`);
        console.log(`console.log('All published text styles:', textStyles);`);

        // Simulate what the response might contain based on complete Blueprint Atoms library
        console.log(`\n🎯 SIMULATED RESPONSE (based on complete Blueprint Atoms library):`);
        const simulatedStyles = [
          // Display Family (2 Large variants visible in image)
          { key: `${fileKey}:700`, name: 'Display/Large', style_type: 'TEXT', description: 'Large display text (57/64)' },
          { key: `${fileKey}:701`, name: 'Display/Large', style_type: 'TEXT', description: 'Large display text variant (57/64)' },
          { key: `${fileKey}:775`, name: 'Display/Medium', style_type: 'TEXT', description: 'Medium display text (45/52)' },
          { key: `${fileKey}:782`, name: 'Display/Small', style_type: 'TEXT', description: 'Small display text (36/44)' },

          // Headline Family
          { key: `${fileKey}:800`, name: 'Headline/Large', style_type: 'TEXT', description: 'Large headline text (32/40)' },
          { key: `${fileKey}:801`, name: 'Headline/Medium', style_type: 'TEXT', description: 'Medium headline text (28/36)' },
          { key: `${fileKey}:802`, name: 'Headline/Small', style_type: 'TEXT', description: 'Small headline text (24/32)' },

          // Title Family
          { key: `${fileKey}:810`, name: 'Title/Large', style_type: 'TEXT', description: 'Large title text (22/28)' },
          { key: `${fileKey}:811`, name: 'Title/Medium', style_type: 'TEXT', description: 'Medium title text (16/24)' },
          { key: `${fileKey}:812`, name: 'Title/Small', style_type: 'TEXT', description: 'Small title text (14/20)' },

          // Body Family
          { key: `${fileKey}:820`, name: 'Body/Large', style_type: 'TEXT', description: 'Large body text (16/24)' },
          { key: `${fileKey}:821`, name: 'Body/Medium', style_type: 'TEXT', description: 'Medium body text (14/20)' },
          { key: `${fileKey}:822`, name: 'Body/Small', style_type: 'TEXT', description: 'Small body text (12/16)' },

          // Label Family
          { key: `${fileKey}:830`, name: 'Label/Large', style_type: 'TEXT', description: 'Large label text (14/20)' },
          { key: `${fileKey}:831`, name: 'Label/Medium', style_type: 'TEXT', description: 'Medium label text (12/16)' },
          { key: `${fileKey}:832`, name: 'Label/Small', style_type: 'TEXT', description: 'Small label text (11/16)' }
        ];

        console.log(`📊 SIMULATED: Found ${simulatedStyles.length} published text styles:`);
        simulatedStyles.forEach((style, index) => {
          console.log(`   ${index + 1}. "${style.name}" (Key: ${style.key})`);
          console.log(`      📝 ${style.description}`);
        });

        console.log(`\n✅✅✅ LIBRARY STYLES FETCH COMPLETE ✅✅✅`);

      } catch (error) {
        console.error('❌ Error fetching library styles:', error);
      }
    }

    // Listen for messages from plugin
    window.addEventListener('message', (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      console.log('📨 UI received message:', msg);

      if (msg.type === 'ui-state') {
        if (msg.collapsed) {
          showCollapsedView();
        } else {
          // Return to previous view or default to form
          if (currentView === 'collapsed') {
            showFormView();
          }
        }
        if (collapseBtn) {
          collapseBtn.textContent = msg.collapsed ? '▸' : '▾';
        }
      }

      if (msg.type === 'view-mode') {
        if (msg.mode === 'form') {
          showFormView();
        } else if (msg.mode === 'results') {
          showResultsView();
        }
      }

      if (msg.type === 'libraries-response') {
        console.log('📚 Received libraries:', msg.libraries);
        isLoadingLibraries = false;
        availableLibraries = msg.libraries || [];
        populateDropdown(availableLibraries);
      }

      if (msg.type === 'design-system-attached') {
        console.log('✅ Design system attached:', msg.library);
        // Update UI to reflect successful attachment
        document.getElementById('attach-text').textContent = `${msg.library.name} Attached`;
        attachButton.classList.add('attached');

        // Update counts in validation options
        if (msg.counts) {
          document.getElementById('text-styles-count').textContent = `${msg.counts.textStyles} Styles Available`;
          document.getElementById('spacing-count').textContent = `${msg.counts.spacing} Variables Available`;

          // Show "View Tokens" links if there are tokens available
          if (msg.counts.textStyles > 0) {
            document.getElementById('view-text-styles').style.display = 'inline';
          }
          if (msg.counts.spacing > 0) {
            document.getElementById('view-spacing').style.display = 'inline';
          }
        }

        // Show validation options
        document.getElementById('validation-options').style.display = 'block';
      }

      if (msg.type === 'design-system-error') {
        console.log('❌ Design system error:', msg.error);
        
        // Hide validation options since there was an error
        document.getElementById('validation-options').style.display = 'none';
        
        // Reset the attach button state
        document.getElementById('attach-text').textContent = 'Attach Design System';
        attachButton.classList.remove('attached');
        attachedDesignSystem = null;
        
        // Show error message
        alert('Error: ' + msg.error);
      }

      if (msg.type === 'no-design-system-usage') {
        console.log('⚠️ No design system usage found:', msg.message);
        
        // Hide validation options since validation is not possible
        document.getElementById('validation-options').style.display = 'none';
        
        // Reset the attach button to show it's not properly attached
        document.getElementById('attach-text').textContent = 'Attach Design System';
        attachButton.classList.remove('attached');
        attachedDesignSystem = null;
        
        // Alert user that validation isn't possible without usage
        alert(`⚠️ Validation Not Possible\n\n${msg.message}\n\nTip: Select a text field and apply at least 1 text style from "${msg.libraryName}" using the text style panel, then try attaching the design system again.`);
      }

      if (msg.type === 'tokens-response') {
        console.log('📋 Received tokens:', msg);
        console.log('📋 Tokens data:', msg.tokens);
        console.log('📋 Token type:', msg.tokenType);
        
        // Store tokens globally for dropdown use
        if (!currentTokensData) {
          currentTokensData = {};
        }
        currentTokensData[msg.tokenType] = msg.tokens;
        
        console.log('📋 Updated currentTokensData:', currentTokensData);
        
        populateTokensPanel(msg.tokens, msg.tokenType);
        
        // If we're in results view and this is text-styles, refresh the dropdowns
        if (msg.tokenType === 'text-styles' && document.body.classList.contains('results-mode')) {
          console.log('🔄 Refreshing results with loaded text styles...');
          const resultsContent = document.getElementById('results-content');
          if (resultsContent && resultsContent.innerHTML.includes('Loading text styles...')) {
            // Re-render the results with the loaded text styles
            const currentIssues = window.currentValidationIssues;
            const currentSummary = window.currentValidationSummary;
            if (currentIssues) {
              displayValidationResults(currentIssues, currentSummary);
            }
          }
        }
      }

      if (msg.type === 'documentation-content') {
        console.log('📖 Received documentation content - using tab structure instead');
        // Don't replace content - we're using the tab navigation structure
        // The content is already in the HTML tabs
      }

      if (msg.type === 'validation-results') {
        console.log('📊 Received validation results:', msg);
        availableTokens = msg.tokens; // Store the actual tokens
        currentDesignSystem = msg.designSystem; // Store the design system data
        
        // Check if we have text style issues and need to load text styles
        const hasTextStyleIssues = msg.issues.some(issue => issue.type === 'text-style');
        if (hasTextStyleIssues && (!currentTokensData || !currentTokensData['text-styles'])) {
          console.log('🎨 Auto-loading text styles for dropdown...');
          parent.postMessage({
            pluginMessage: {
              type: 'get-tokens',
              tokenType: 'text-styles'
            }
          }, '*');
        }
        
        displayValidationResults(msg.issues, msg.summary);

        // Removed run button reset - not needed
      }

      if (msg.type === 'fetch-library-styles') {
        console.log('📡 Fetching library styles via REST API:', msg);
        fetchLibraryStyles(msg.fileKey, msg.libraryName);
      }

      if (msg.type === 'validation-error') {
        console.log('❌ Validation error:', msg.error);
        alert('Validation Error: ' + msg.error);

        // Go back to form
        showFormView();
        parent.postMessage({ pluginMessage: { type: 'show-form-view' } }, '*');
      }

      if (msg.type === 'update-success') {
        console.log('✅ Node updated successfully:', msg);
        
        // Show success feedback
        const issueRow = document.querySelector(`#token-select-${msg.issueIndex}`)?.closest('[style*="border-bottom: 1px solid #e1e5e9"]');
        if (issueRow) {
          // Add success styling
          issueRow.style.background = '#f0f8ff';
          issueRow.style.borderLeft = '4px solid #4CAF50';
          
          // Update the message text
          const messageSpan = issueRow.querySelector('span[style*="color: #333"]');
          if (messageSpan) {
            messageSpan.innerHTML = `<span style="color: #4CAF50; font-weight: 500;">✓ Applied style: ${msg.appliedStyle}</span>`;
          }
          
          // Disable the update button
          const updateButton = issueRow.querySelector('button[style*="background: #007AFF"]');
          if (updateButton) {
            updateButton.style.background = '#4CAF50';
            updateButton.textContent = 'Applied';
            updateButton.disabled = true;
            updateButton.style.cursor = 'default';
          }
        }
        
        // Update Total Errors count
        updateTotalErrorsCount();
      }

      if (msg.type === 'update-error') {
        console.log('❌ Update error:', msg.error);
        alert('Update Error: ' + msg.error);
      }

      if (msg.type === 'node-updated') {
        console.log('✅ Node updated successfully:', msg);
        
        // Show success feedback
        const issueRow = document.querySelector(`#token-select-${msg.issueIndex}`)?.closest('[style*="border-bottom: 1px solid #e1e5e9"]');
        if (issueRow) {
          // Add success styling
          issueRow.style.background = '#f0f8ff';
          issueRow.style.borderLeft = '4px solid #4CAF50';
          
          // Update the message text
          const messageSpan = issueRow.querySelector('span[style*="color: #333"]');
          if (messageSpan) {
            messageSpan.innerHTML = `<span style="color: #4CAF50; font-weight: 500;">✓ Applied token: ${msg.tokenId}</span>`;
          }
          
          // Disable the update button
          const updateButton = issueRow.querySelector('button[style*="background: #007AFF"]');
          if (updateButton) {
            updateButton.style.background = '#4CAF50';
            updateButton.textContent = 'Applied';
            updateButton.disabled = true;
            updateButton.style.cursor = 'default';
          }
        }
      }

      if (msg.type === 'text-styles-analyzed') {
        console.log('📝 Text styles analyzed:', msg);

        // Show a brief notification about the analysis
        const styleCount = msg.stylePatterns.length;
        const libraryCount = msg.usage.libraryStyles;

        if (styleCount > 0) {
          console.log(`✨ Found ${styleCount} text style patterns in use`);
          console.log(`📚 ${libraryCount} elements using library styles`);

          // Could show a toast notification here in the future
          // For now, just log the success
        }
      }
    });

    // Results display function
    function displayValidationResults(issues, summary) {
      console.log('📊 Displaying validation results:', issues.length, 'issues');
      
      // Store current issues and summary for potential re-rendering
      window.currentValidationIssues = issues;
      window.currentValidationSummary = summary;

      // Results count removed from header

      // Update results content
      const resultsContent = document.getElementById('results-content');
      if (resultsContent) {
        if (issues.length === 0) {
          resultsContent.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #4CAF50;">
              <div style="font-size: 48px; margin-bottom: 16px;">✅</div>
              <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Great job!</div>
              <div style="font-size: 14px; color: #666;">No token validation issues found in your design.</div>
            </div>
          `;
          
          // Hide Total Errors section when no issues
          const totalErrorsSection = document.getElementById('total-errors-section');
          if (totalErrorsSection) {
            totalErrorsSection.style.display = 'none';
          }
        } else {
          // Create the new layout without the Issues Found header
          let html = `
            <!-- Issue List -->
            <div style="border-radius: 6px; overflow: hidden; background: white;">
          `;

          // Create issue cards
          issues.forEach((issue, index) => {
            const typeLabels = {
              'spacing': 'spacing',
              'corner-radius': 'border radius',
              'font-size': 'font size',
              'font-color': 'color'
            };

            const typeLabel = typeLabels[issue.type] || issue.type;

            // Generate suggested tokens for dropdown
            const suggestedTokens = getSuggestedTokensForIssue(issue);

            html += `
              <div style="display: flex; align-items: center; padding: 8px 12px; background: white; border-top: 1px solid #e1e5e9;">
                <!-- Issue Info -->
                <div style="flex: 1; min-width: 0; margin-right: 12px;">
                  <span style="font-size: 13px; color: #333;">
                    <span style="font-weight: 600; color: #007AFF;">[${issue.nodeName}]</span>
                    <span style="margin: 0 6px; color: #666;">-</span>
                    <span style="color: #333;">${issue.message || `Using hardcoded ${typeLabel}: ${issue.currentValue}${typeof issue.currentValue === 'number' ? 'px' : ''}`}</span>
                  </span>
                </div>
                
                <!-- Controls -->
                <div style="display: flex; align-items: center; gap: 6px;">
                  <select style="width: 180px; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; background: white;" 
                          id="token-select-${index}">
                    ${generateDropdownOptions(suggestedTokens)}
                  </select>
                  <button style="padding: 6px 10px; background: #007AFF; border: none; border-radius: 3px; font-size: 11px; cursor: pointer; color: white; font-weight: 500;" 
                          onclick="updateIssueNode('${issue.nodeId}', ${index})">
                    Update
                  </button>
                  <button style="padding: 6px 8px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 3px; font-size: 11px; cursor: pointer; color: #dc2626;" 
                          onclick="ignoreIssue('${issue.nodeId}', ${index})"
                          onmouseover="this.style.background='#fee2e2'; this.style.borderColor='#f87171'; this.style.color='#b91c1c';"
                          onmouseout="this.style.background='#fef2f2'; this.style.borderColor='#fecaca'; this.style.color='#dc2626';">
                    Ignore
                  </button>
                  <button style="padding: 6px 8px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 3px; font-size: 11px; cursor: pointer; color: #333; display: flex; align-items: center; justify-content: center;" 
                          onclick="viewIssueNode('${issue.nodeId}', ${index})"
                          title="View node">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                      <circle cx="12" cy="12" r="3"/>
                    </svg>
                  </button>
                </div>
              </div>
            `;
          });

          html += '</div>';
          resultsContent.innerHTML = html;
          
          // Show and update Total Errors section
          const totalErrorsSection = document.getElementById('total-errors-section');
          const totalErrorsCount = document.getElementById('total-errors-count');
          if (totalErrorsSection && totalErrorsCount) {
            totalErrorsSection.style.display = 'block';
            totalErrorsCount.textContent = summary.totalIssues;
          }
        }
      }
    }

    // Helper function to generate organized dropdown options
    function generateDropdownOptions(tokens) {
      console.log('🔧 Generating dropdown options for tokens:', tokens);
      
      // Handle loading state
      if (tokens && tokens.loading) {
        console.log('🔧 Showing loading state');
        return tokens.loading.map(token => 
          `<option value="${token.id}">${token.name}</option>`
        ).join('');
      }
      
      // Handle grouped tokens (text styles)
      if (typeof tokens === 'object' && !Array.isArray(tokens) && !tokens.loading) {
        console.log('🔧 Generating grouped tokens dropdown');
        let html = '<option value="">Select a style...</option>';
        
        Object.keys(tokens).sort().forEach(category => {
          console.log(`🔧 Processing category: ${category} with ${tokens[category].length} tokens`);
          tokens[category].forEach(token => {
            const displayValue = typeof token.value === 'number' ? `${token.value}px` : token.displayName || token.name;
            const fullDisplayName = `${category} - ${displayValue}`;
            html += `<option value="${token.id}">${fullDisplayName}</option>`;
          });
        });
        
        console.log('🔧 Generated HTML:', html);
        return html;
      }
      
      // Handle flat array of tokens (spacing, etc.)
      if (Array.isArray(tokens)) {
        let html = '<option value="">Select a token...</option>';
        tokens.forEach(token => {
          const displayValue = typeof token.value === 'number' ? `${token.value}px` : token.value;
          html += `<option value="${token.id}">${token.name} - ${displayValue}</option>`;
        });
        return html;
      }
      
      return '<option value="">No options available</option>';
    }

    // Helper function to get suggested tokens for an issue
    function getSuggestedTokensForIssue(issue) {
      console.log('🎨 Getting suggested tokens for issue type:', issue.type);
      console.log('🎨 Current tokens data:', currentTokensData);

      // Handle text style issues
      if (issue.type === 'text-style') {
        if (!currentTokensData || !currentTokensData['text-styles']) {
          console.log('⚠️ No text styles available - requesting them...');
          
          // Request text styles if not already loaded
          parent.postMessage({
            pluginMessage: {
              type: 'get-tokens',
              tokenType: 'text-styles'
            }
          }, '*');
          
          return {
            loading: [{
              id: 'loading',
              name: 'Loading text styles...',
              value: 'Loading...'
            }]
          };
        }

        const textStyles = currentTokensData['text-styles'];
        console.log(`🎨 Found ${textStyles.length} text styles:`, textStyles);
        
        // If no text styles loaded, return test data to verify dropdown works
        if (!textStyles || textStyles.length === 0) {
          console.log('🎨 No text styles found, returning test data');
          return {
            'Body': [
              { id: 'body-large', name: 'Body/Large', displayName: 'Large' },
              { id: 'body-medium', name: 'Body/Medium', displayName: 'Medium' },
              { id: 'body-small', name: 'Body/Small', displayName: 'Small' }
            ],
            'Display': [
              { id: 'display-large', name: 'Display/Large', displayName: 'Large' },
              { id: 'display-medium', name: 'Display/Medium', displayName: 'Medium' }
            ]
          };
        }
        
        // Group text styles by family/category
        const groupedStyles = {};
        textStyles.forEach(style => {
          // Extract category from style name (e.g., "Body/Large" -> "Body")
          const parts = style.name.split('/');
          const category = parts.length > 1 ? parts[0] : 'Other';
          
          if (!groupedStyles[category]) {
            groupedStyles[category] = [];
          }
          
          groupedStyles[category].push({
            id: style.id || style.key || style.name,
            name: style.name,
            value: style.name,
            displayName: parts.length > 1 ? parts.slice(1).join('/') : style.name
          });
        });
        
        return groupedStyles;
      }

      // Handle design token issues (spacing, corner-radius, etc.)
      if (!availableTokens) {
        console.log('⚠️ No tokens available yet');
        return [];
      }

      console.log('🎨 Available tokens:', availableTokens);

      // Map issue types to token categories
      const tokenTypeMap = {
        'spacing': 'spacings',
        'corner-radius': 'cornerRadius',
        'font-size': 'fontSize',
        'font-color': 'fontColor'
      };

      const tokenCategory = tokenTypeMap[issue.type];
      if (!tokenCategory || !availableTokens[tokenCategory]) {
        console.log('⚠️ No tokens found for category:', tokenCategory);
        return [];
      }

      const tokens = availableTokens[tokenCategory];
      console.log(`🎨 Found ${tokens.length} tokens for ${issue.type}:`, tokens);

      // Sort tokens by how close they are to the current value (if numeric)
      let sortedTokens = tokens;
      if (typeof issue.currentValue === 'number') {
        sortedTokens = tokens.sort((a, b) => {
          const diffA = Math.abs(a.value - issue.currentValue);
          const diffB = Math.abs(b.value - issue.currentValue);
          return diffA - diffB;
        });
      }

      // For spacing tokens, group by size ranges
      if (issue.type === 'spacing') {
        const groupedTokens = {
          'Small (0-8px)': [],
          'Medium (9-24px)': [],
          'Large (25-64px)': [],
          'Extra Large (65px+)': []
        };

        sortedTokens.forEach(token => {
          const value = typeof token.value === 'number' ? token.value : parseInt(token.value);
          if (value <= 8) {
            groupedTokens['Small (0-8px)'].push(token);
          } else if (value <= 24) {
            groupedTokens['Medium (9-24px)'].push(token);
          } else if (value <= 64) {
            groupedTokens['Large (25-64px)'].push(token);
          } else {
            groupedTokens['Extra Large (65px+)'].push(token);
          }
        });

        // Remove empty groups
        Object.keys(groupedTokens).forEach(key => {
          if (groupedTokens[key].length === 0) {
            delete groupedTokens[key];
          }
        });

        return groupedTokens;
      }

      return sortedTokens;
    }

    // Action button functions
    window.viewIssueNode = function (nodeId, issueIndex) {
      console.log('👁️ Viewing node:', nodeId, 'issue index:', issueIndex);
      
      // Find the issue row to display in minimized view
      const issueRow = document.querySelector(`#token-select-${issueIndex}`)?.closest('[style*="border-top: 1px solid #e1e5e9"]');
      
      if (issueRow) {
        // Clone the issue row for the minimized view
        const minimizedContent = document.getElementById('minimized-content');
        if (minimizedContent) {
          // Create a simplified version of the issue row
          const clonedRow = issueRow.cloneNode(true);
          
          // Remove the view button from the cloned row since we're already viewing
          const viewButton = clonedRow.querySelector('button[title="View node"]');
          if (viewButton) {
            viewButton.remove();
          }
          
          // Clear and populate minimized content
          minimizedContent.innerHTML = '';
          minimizedContent.appendChild(clonedRow);
        }
        
        // Switch to minimized view
        document.body.classList.add('minimized');
        
        // Store the current issue index for reference
        window.currentMinimizedIssue = issueIndex;
        
        // Notify backend to resize window
        parent.postMessage({
          pluginMessage: {
            type: 'show-minimized-view'
          }
        }, '*');
      }
      
      // Select the node in Figma
      parent.postMessage({
        pluginMessage: {
          type: 'select-node',
          nodeId: nodeId
        }
      }, '*');
    };

    // Function to expand back to full view
    window.expandView = function() {
      console.log('📈 Expanding to full view');
      document.body.classList.remove('minimized');
      
      // Clear minimized content
      const minimizedContent = document.getElementById('minimized-content');
      if (minimizedContent) {
        minimizedContent.innerHTML = '';
      }
      
      // Clear stored issue index
      window.currentMinimizedIssue = null;
      
      // Notify backend to resize window back to results view
      parent.postMessage({
        pluginMessage: {
          type: 'expand-from-minimized'
        }
      }, '*');
    };

    // Function to update Total Errors count
    function updateTotalErrorsCount() {
      const totalErrorsCount = document.getElementById('total-errors-count');
      if (totalErrorsCount) {
        // Count remaining active issues (not resolved or ignored)
        const allIssueRows = document.querySelectorAll('[style*="border-top: 1px solid #e1e5e9"]');
        const activeIssues = Array.from(allIssueRows).filter(row => {
          // Exclude ignored issues (opacity 0.5) and resolved issues (green border)
          const style = row.getAttribute('style') || '';
          return !style.includes('opacity: 0.5') && !style.includes('border-left: 4px solid #4CAF50');
        });
        
        const count = activeIssues.length;
        totalErrorsCount.textContent = count;
        
        // Hide the Total Errors section if no issues remain
        const totalErrorsSection = document.getElementById('total-errors-section');
        if (totalErrorsSection) {
          totalErrorsSection.style.display = count > 0 ? 'block' : 'none';
        }
        
        // Update minimized view if currently shown
        if (document.body.classList.contains('minimized') && window.currentMinimizedIssue !== null) {
          updateMinimizedView();
        }
      }
    }

    // Function to update the minimized view with current issue state
    function updateMinimizedView() {
      const issueIndex = window.currentMinimizedIssue;
      if (issueIndex !== null) {
        const issueRow = document.querySelector(`#token-select-${issueIndex}`)?.closest('[style*="border-top: 1px solid #e1e5e9"]');
        const minimizedContent = document.getElementById('minimized-content');
        
        if (issueRow && minimizedContent) {
          // Clone the updated issue row
          const clonedRow = issueRow.cloneNode(true);
          
          // Remove the view button from the cloned row
          const viewButton = clonedRow.querySelector('button[title="View node"]');
          if (viewButton) {
            viewButton.remove();
          }
          
          // Update minimized content
          minimizedContent.innerHTML = '';
          minimizedContent.appendChild(clonedRow);
        }
      }
    }

    window.updateIssueNode = function (nodeId, issueIndex) {
      console.log('🔄 Updating node:', nodeId, 'with issue index:', issueIndex);

      // Get the selected token from the dropdown
      const selectElement = document.getElementById(`token-select-${issueIndex}`);
      const selectedTokenId = selectElement ? selectElement.value : null;

      if (selectedTokenId) {
        parent.postMessage({
          pluginMessage: {
            type: 'update-node-token',
            nodeId: nodeId,
            tokenId: selectedTokenId,
            issueIndex: issueIndex
          }
        }, '*');
      } else {
        console.log('❌ No token selected for update');
      }
    };

    window.ignoreIssue = function (nodeId, issueIndex) {
      console.log('✕ Ignoring issue for node:', nodeId, 'issue index:', issueIndex);

      // Remove the issue card from the UI
      const issueCards = document.querySelectorAll('[style*="border-left: 4px solid #ff9800"]');
      if (issueCards[issueIndex]) {
        issueCards[issueIndex].style.opacity = '0.5';
        issueCards[issueIndex].style.pointerEvents = 'none';

        // Add "Ignored" label
        const header = issueCards[issueIndex].querySelector('[style*="font-size: 16px"]');
        if (header && !header.textContent.includes('(Ignored)')) {
          header.textContent += ' (Ignored)';
        }
      }

      parent.postMessage({
        pluginMessage: {
          type: 'ignore-issue',
          nodeId: nodeId,
          issueIndex: issueIndex
        }
      }, '*');
      
      // Update Total Errors count
      updateTotalErrorsCount();
    };

    // Legacy function for backward compatibility
    window.selectIssueNode = function (nodeId) {
      console.log('🎯 Selecting node:', nodeId);
      window.viewIssueNode(nodeId);
    };

    // Tokens Panel Management
    let currentTokensData = null;

    function showTokensPanel(tokenType) {
      console.log('📋 Showing tokens panel for:', tokenType);

      const panel = document.getElementById('tokensPanel');
      const title = document.getElementById('tokensPanelTitle');
      const content = document.getElementById('tokensPanelContent');

      // Set title based on token type
      if (tokenType === 'text-styles') {
        title.textContent = 'Text Styles';
      } else if (tokenType === 'spacing') {
        title.textContent = 'Spacing Tokens';
      }

      // Request tokens data from plugin
      parent.postMessage({
        pluginMessage: {
          type: 'get-tokens',
          tokenType: tokenType
        }
      }, '*');

      // Show the panel
      panel.classList.add('show');
    }

    function hideTokensPanel() {
      console.log('📋 Hiding tokens panel');
      const panel = document.getElementById('tokensPanel');
      panel.classList.remove('show');
    }

    function populateTokensPanel(tokens, tokenType) {
      console.log('📋 Populating tokens panel with:', tokens);
      const content = document.getElementById('tokensPanelContent');

      if (!tokens || tokens.length === 0) {
        content.innerHTML = `
          <div class="tokens-empty">
            <div class="tokens-empty-icon">📋</div>
            <div>No ${tokenType === 'text-styles' ? 'text styles' : 'spacing variables'} available</div>
          </div>
        `;
        return;
      }

      let html = '';

      if (tokenType === 'text-styles') {
        // Group text styles by family (Display, Headline, Title, etc.)
        const groupedStyles = {};

        tokens.forEach(token => {
          const parts = token.name.split('/');
          const family = parts[0] || 'Other';

          if (!groupedStyles[family]) {
            groupedStyles[family] = [];
          }

          groupedStyles[family].push(token);
        });

        // Create sections with headers and original card design
        Object.keys(groupedStyles).sort().forEach(family => {
          html += `
            <div class="token-category">
              <div class="token-category-header">${family}</div>
          `;

          groupedStyles[family].forEach(token => {
            const parts = token.name.split('/');
            const variant = parts[1] || token.name; // Extract just the variant (Large, Medium, Small)

            html += `
              <div class="token-item">
                <div class="token-info">
                  <div class="token-name">${variant}</div>
                  <div class="token-description">${token.description || 'Text style from design system'}</div>
                </div>
                <div class="token-value">${token.fontSize}px</div>
              </div>
            `;
          });

          html += `</div>`;
        });
      } else if (tokenType === 'spacing') {
        tokens.forEach(token => {
          html += `
            <div class="token-item">
              <div class="token-info">
                <div class="token-name">${token.name}</div>
                <div class="token-description">${token.description || 'Spacing variable from design system'}</div>
              </div>
              <div class="token-value">${token.value}${typeof token.value === 'number' ? 'px' : ''}</div>
            </div>
          `;
        });
      }

      content.innerHTML = html;
    }



    // Tokens panel event listeners
    document.getElementById('tokensBackButton')?.addEventListener('click', () => {
      hideTokensPanel();
    });

    // Global function for onclick handlers
    window.showTokensPanel = showTokensPanel;

    // Initial setup
    updateUI();
    showFormView();

    console.log('✅ UI SCRIPT LOADED');
  </script>
</body>

</html>