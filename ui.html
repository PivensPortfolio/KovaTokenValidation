<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <style>
    :root {
      --header-h: 40px;
    }

    html,
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      height: 100vh;
    }

    #header {
      height: var(--header-h);
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: white;
      border-bottom: 1px solid #e1e5e9;
      font-weight: 600;
    }

    #collapseToggle {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
    }

    #collapseToggle:hover {
      background: #f0f0f0;
    }

    #content {
      height: calc(100vh - var(--header-h));
      overflow: auto;
      padding: 20px;
    }

    body.collapsed #content {
      display: none;
    }

    /* Form View Styles */
    .main-title {
      font-size: 24px;
      font-weight: 700;
      color: #333;
      margin: 0 0 8px 0;
    }

    .description {
      font-size: 14px;
      color: #666;
      margin: 0 0 24px 0;
      line-height: 1.4;
    }

    .section {
      margin-bottom: 24px;
      background: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .helper-text {
      font-size: 12px;
      color: #666;
      margin-bottom: 12px;
      line-height: 1.3;
    }

    .attach-button {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #6B7280;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      color: white;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
      width: 100%;
      justify-content: center;
    }

    .attach-button:hover {
      background: #4B5563;
    }

    .attach-button.attached {
      background: #4CAF50;
    }

    .attach-button.loading {
      background: #999;
      cursor: not-allowed;
    }

    .dropdown-arrow {
      margin-left: auto;
      font-size: 12px;
      transition: transform 0.2s;
    }

    .attach-button.open .dropdown-arrow {
      transform: rotate(180deg);
    }

    .library-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }

    .library-dropdown.show {
      display: block;
    }

    .library-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }

    .library-item:last-child {
      border-bottom: none;
    }

    .library-item:hover:not(.loading):not(.no-libraries) {
      background: #f8f9fa;
    }

    .library-item.loading {
      color: #666;
      cursor: default;
      font-style: italic;
    }

    .library-item.no-libraries {
      color: #999;
      cursor: default;
      text-align: center;
      font-style: italic;
    }

    .library-name {
      font-weight: 500;
      color: #333;
    }

    .library-type {
      font-size: 12px;
      color: #666;
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 3px;
    }

    .attach-container {
      position: relative;
    }

    .checkbox-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
      cursor: pointer;
    }

    .checkbox {
      width: 16px;
      height: 16px;
      border: 2px solid #ddd;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .checkbox.checked {
      background: #007AFF;
      border-color: #007AFF;
    }

    .checkbox.checked::after {
      content: '✓';
      color: white;
      font-size: 10px;
      font-weight: bold;
    }

    .checkbox-label {
      flex: 1;
      cursor: pointer;
    }

    .option-name {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #333;
      margin-bottom: 2px;
    }

    .option-description {
      display: block;
      font-size: 12px;
      color: #666;
      line-height: 1.3;
    }

    .run-button {
      background: #007AFF;
      border: none;
      border-radius: 6px;
      padding: 12px 24px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
    }

    .run-button:hover:not(.disabled) {
      background: #0056CC;
    }

    .run-button.disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .run-button.ready {
      background: #4CAF50;
    }

    .run-button-help {
      font-size: 12px;
      color: #666;
      text-align: center;
      margin-top: 8px;
    }

    .run-button-help.ready {
      color: #4CAF50;
    }

    .validation-error {
      display: none;
      background: #ffebee;
      border: 1px solid #ffcdd2;
      border-radius: 4px;
      padding: 8px 12px;
      margin-top: 8px;
      font-size: 12px;
      color: #d32f2f;
    }

    .validation-error.show {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .validation-warning {
      display: none;
      background: #fff3e0;
      border: 1px solid #ffcc02;
      border-radius: 4px;
      padding: 8px 12px;
      margin-top: 8px;
      font-size: 12px;
      color: #f57c00;
    }

    .validation-warning.show {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* View-specific styles */
    .view-form {
      display: block;
    }

    .view-results {
      display: none;
    }

    .view-collapsed {
      display: none;
    }

    /* Results View Styles */
    .results-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e1e5e9;
    }

    .back-button {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f0f0f0;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      color: #333;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .back-button:hover {
      background: #e0e0e0;
    }

    .back-icon {
      font-size: 16px;
    }

    .results-title-section {
      flex: 1;
    }

    .results-title {
      font-size: 20px;
      font-weight: 700;
      color: #333;
      margin: 0;
    }

    .results-count {
      font-size: 14px;
      color: #666;
      margin-top: 2px;
    }

    .results-content {
      /* Content will be styled dynamically */
    }

    /* Issue card specific styles */
    .issue-card {
      background: white;
      border-radius: 8px;
      border-left: 4px solid #ff9800;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 16px;
    }

    .issue-card:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .token-select {
      flex: 1;
      padding: 8px 12px;
      border: 2px solid #007AFF;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      cursor: pointer;
    }

    .token-select:focus {
      outline: none;
      border-color: #0056CC;
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    .action-button {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      font-family: inherit;
    }

    .action-button.view {
      background: #f8f9fa;
      border: 1px solid #ddd;
      color: #333;
    }

    .action-button.view:hover {
      background: #e9ecef;
    }

    .action-button.update {
      background: #007AFF;
      color: white;
      font-weight: 500;
      padding: 8px 16px;
    }

    .action-button.update:hover {
      background: #0056CC;
    }

    .action-button.ignore {
      background: transparent;
      color: #666;
    }

    .action-button.ignore:hover {
      background: #f8f9fa;
      color: #333;
    }

    .issues-header {
      background: #fff3e0;
      border: 1px solid #ffcc02;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .best-match-section {
      margin-bottom: 16px;
    }

    .best-match-label {
      font-size: 12px;
      color: #007AFF;
      font-weight: 500;
      margin-bottom: 8px;
    }

    /* When in results mode */
    body.results-mode .view-form {
      display: none;
    }

    body.results-mode .view-results {
      display: block;
    }

    /* When collapsed */
    body.collapsed .view-form,
    body.collapsed .view-results {
      display: none;
    }

    body.collapsed .view-collapsed {
      display: flex;
      align-items: center;
      justify-content: center;
      height: calc(100vh - var(--header-h));
      padding: 16px;
    }

    .collapsed-content {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      width: 100%;
    }

    .expand-button {
      background: #007AFF;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      cursor: pointer;
      font-family: inherit;
      font-size: 14px;
      color: white;
      font-weight: 600;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
      min-width: 140px;
      text-align: center;
    }

    .expand-button:hover {
      background: #0056CC;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
    }

    /* Validation Options */
    .validation-options {
      margin-top: 20px;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e1e5e9;
    }

    .option-group {
      margin: 16px 0;
    }

    .option-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      margin-bottom: 8px;
      background: white;
      border-radius: 6px;
      border: 1px solid #e1e5e9;
      cursor: pointer;
      transition: all 0.2s;
    }

    .option-item:hover {
      border-color: #6B7280;
      background: #fafbfc;
    }

    .option-item input[type="checkbox"] {
      appearance: none;
      -webkit-appearance: none;
      margin: 0;
      width: 16px;
      height: 16px;
      border: 2px solid #ddd;
      border-radius: 3px;
      background: white;
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease;
    }

    .option-item input[type="checkbox"]:checked {
      background: #E8F5E8;
      border-color: #4CAF50;
    }

    .option-item input[type="checkbox"]:checked::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #000;
      font-size: 10px;
      font-weight: bold;
      line-height: 1;
    }

    .option-content {
      flex: 1;
    }

    .option-title {
      font-weight: 500;
      font-size: 14px;
      color: #1a1a1a;
      margin-bottom: 4px;
    }

    .option-description {
      font-size: 12px;
      color: #666;
      line-height: 1.4;
      margin-bottom: 4px;
    }

    .option-count {
      font-size: 11px;
      color: #4CAF50;
      font-weight: 500;
    }

    .run-validation-button {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #4CAF50;
      border: none;
      border-radius: 6px;
      padding: 12px 20px;
      color: white;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
      justify-content: center;
      margin-top: 16px;
    }

    .run-validation-button:hover {
      background: #45a049;
      transform: translateY(-1px);
    }

    .run-validation-button:disabled,
    .run-validation-button.disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .run-icon {
      font-size: 12px;
    }

    /* View Tokens Link */
    .view-tokens-link {
      background: none;
      border: none;
      color: #007AFF;
      font-size: 11px;
      cursor: pointer;
      text-decoration: underline;
      padding: 0;
      font-family: inherit;
    }

    .view-tokens-link:hover {
      color: #0056CC;
    }

    /* Tokens Panel */
    .tokens-panel {
      position: fixed;
      top: 0;
      right: -100%;
      width: 100%;
      height: 100vh;
      background: white;
      z-index: 2000;
      transition: right 0.3s ease;
      overflow-y: auto;
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
    }

    .tokens-panel.show {
      right: 0;
    }

    .tokens-panel-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #e1e5e9;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .tokens-back-button {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f0f0f0;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      color: #333;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tokens-back-button:hover {
      background: #e0e0e0;
    }

    .tokens-panel-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin: 0;
    }

    .tokens-panel-content {
      padding: 20px;
    }

    .token-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      margin-bottom: 8px;
      background: white;
      border: 1px solid #e1e5e9;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .token-item:hover {
      border-color: #007AFF;
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.1);
    }

    .token-info {
      flex: 1;
    }

    .token-name {
      font-size: 14px;
      font-weight: 500;
      color: #333;
      margin-bottom: 4px;
    }

    .token-description {
      font-size: 12px;
      color: #666;
    }

    .token-value {
      font-size: 14px;
      color: #007AFF;
      font-weight: 500;
      font-family: 'SF Mono', Monaco, monospace;
    }

    .tokens-empty {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    .tokens-empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    /* Token Categories */
    .token-category {
      margin-bottom: 24px;
    }

    .token-category-header {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e1e5e9;
    }

    /* Documentation Link */
    .documentation-section {
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid #e1e5e9;
      text-align: center;
    }

    .documentation-link {
      background: none;
      border: none;
      color: #007AFF;
      font-size: 14px;
      cursor: pointer;
      text-decoration: underline;
      padding: 8px 16px;
      border-radius: 6px;
      transition: all 0.2s;
      font-family: inherit;
    }

    .documentation-link:hover {
      background: #f0f8ff;
      color: #0056CC;
      text-decoration: none;
    }

    /* Documentation View */
    .view-documentation {
      display: none;
    }

    .documentation-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e1e5e9;
    }

    .documentation-title-section {
      flex: 1;
    }

    .documentation-title {
      font-size: 20px;
      font-weight: 700;
      color: #333;
      margin: 0;
    }

    .documentation-content {
      line-height: 1.6;
      color: #333;
    }

    .documentation-content h1 {
      font-size: 24px;
      font-weight: 700;
      color: #333;
      margin: 0 0 16px 0;
    }

    .documentation-content h2 {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin: 24px 0 12px 0;
    }

    .documentation-content h3 {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin: 20px 0 8px 0;
    }

    .documentation-content p {
      margin: 0 0 12px 0;
    }

    .documentation-content ul {
      margin: 0 0 12px 20px;
      padding: 0;
    }

    .documentation-content li {
      margin-bottom: 4px;
    }

    .documentation-content code {
      background: #f5f5f5;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 13px;
    }

    .documentation-content pre {
      background: #f8f9fa;
      border: 1px solid #e1e5e9;
      border-radius: 6px;
      padding: 12px;
      overflow-x: auto;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 13px;
      margin: 12px 0;
    }

    /* When in documentation mode */
    body.documentation-mode .view-form,
    body.documentation-mode .view-results {
      display: none;
    }

    body.documentation-mode .view-documentation {
      display: block;
    }
  </style>
</head>

<body>
  <div id="content">
    <!-- Form View -->
    <div class="view-form" id="formView">
      <h1 class="main-title">Token Validation</h1>
      <p class="description">
        Attach a design system to automatically import text styles and access design tokens.
      </p>

      <div class="section design-system-section">
        <div class="section-title">Design System:</div>
        <div class="helper-text">
          Select a design system to validate your design tokens against.
        </div>
        <div class="attach-container">
          <button class="attach-button" id="attach-design-system">
            <span id="attach-text">Attach Design System</span>
            <span class="dropdown-arrow" id="dropdown-arrow">▼</span>
          </button>
          <div class="library-dropdown" id="library-dropdown">
            <div class="library-item loading">Loading design systems...</div>
          </div>
        </div>

        <!-- Validation Options (shown after successful attachment) -->
        <div class="validation-options" id="validation-options" style="display: none;">
          <div class="section-title">Validation Options</div>
          <div class="helper-text">
            Select what you'd like to validate from your attached design system.
          </div>

          <div class="option-group">
            <label class="option-item">
              <input type="checkbox" id="validate-text-styles">
              <span class="checkmark"></span>
              <div class="option-content">
                <div class="option-title">Text Styles</div>
                <div class="option-description">Validate text styles usage from the design system</div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div class="option-count" id="text-styles-count">Loading...</div>
                  <button class="view-tokens-link" id="view-text-styles" style="display: none;"
                    onclick="showTokensPanel('text-styles')">View Tokens</button>
                </div>
              </div>
            </label>

            <label class="option-item">
              <input type="checkbox" id="validate-spacing">
              <span class="checkmark"></span>
              <div class="option-content">
                <div class="option-title">Spacing</div>
                <div class="option-description">Validate spacing tokens and layout consistency</div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div class="option-count" id="spacing-count">Loading...</div>
                  <button class="view-tokens-link" id="view-spacing" style="display: none;"
                    onclick="showTokensPanel('spacing')">View Tokens</button>
                </div>
              </div>
            </label>
          </div>

          <button class="run-validation-button" id="run-validation" disabled>
            <span class="run-icon">▶</span>
            Run Validation
          </button>
        </div>

      </div>

      <!-- Documentation Link -->
      <div class="documentation-section">
        <button class="documentation-link" id="documentation-link">
          Documentation
        </button>
      </div>

    </div>

    <!-- Results View -->
    <div class="view-results" id="resultsView">
      <div class="results-header">
        <button class="back-button" id="back-to-form">
          <span class="back-icon">←</span>
          New Check
        </button>
        <div class="results-title-section">
          <div class="results-title" id="results-title">Results</div>
        </div>
      </div>
      <div class="results-content" id="results-content">
        <!-- Results will be populated here -->
      </div>
    </div>

    <!-- Documentation View -->
    <div class="view-documentation" id="documentationView">
      <div class="documentation-header">
        <button class="back-button" id="documentation-back-button">
          <span class="back-icon">←</span>
          Back
        </button>
        <div class="documentation-title-section">
          <div class="documentation-title">Documentation</div>
        </div>
      </div>
      <div class="documentation-content" id="documentationContent">
        <!-- Documentation content will be loaded here -->
      </div>
    </div>

    <!-- Collapsed View -->
    <div class="view-collapsed" id="collapsedView">
      <div class="collapsed-content">
        <button id="expand-button" class="expand-button">
          Token Validator
        </button>
      </div>
    </div>

    <!-- Tokens Panel -->
    <div class="tokens-panel" id="tokensPanel">
      <div class="tokens-panel-header">
        <button class="tokens-back-button" id="tokensBackButton">
          <span>←</span>
          Back
        </button>
        <h2 class="tokens-panel-title" id="tokensPanelTitle">Available Tokens</h2>
      </div>
      <div class="tokens-panel-content" id="tokensPanelContent">
        <!-- Tokens will be populated here -->
      </div>
    </div>
  </div>



  <script>
    console.log('🔍 UI SCRIPT LOADING');

    // State management
    let currentView = 'form'; // 'form', 'results', 'collapsed'
    // Removed validation options - focusing only on design system attachment
    let attachedDesignSystem = null;
    let availableTokens = null; // Store the actual design tokens

    // Get elements
    const collapseBtn = document.getElementById('collapseToggle');

    // Form elements
    const attachButton = document.getElementById('attach-design-system');
    // Removed runButton - not needed for design system focus
    const backButton = document.getElementById('back-to-form');
    const expandButton = document.getElementById('expand-button');

    // View switching functions
    function showFormView() {
      currentView = 'form';
      document.body.className = '';
      console.log('📋 Switched to Form view');
    }

    function showResultsView() {
      currentView = 'results';
      document.body.className = 'results-mode';
      console.log('📊 Switched to Results view');
    }

    function showCollapsedView() {
      currentView = 'collapsed';
      document.body.className = 'collapsed';
      console.log('🔄 Switched to Collapsed view');
    }

    function showDocumentationView() {
      currentView = 'documentation';
      document.body.className = 'documentation-mode';
      console.log('📖 Switched to Documentation view');
    }

    // Simplified - only need to track design system attachment
    function updateUI() {
      console.log('🔄 Updating UI state');
      // UI updates handled by design system attachment flow
    }

    // Removed checkbox event listeners - no validation options needed

    // Dropdown state
    let isDropdownOpen = false;
    let availableLibraries = [];
    let isLoadingLibraries = false;

    // Main action buttons
    attachButton?.addEventListener('click', (e) => {
      e.stopPropagation();
      console.log('📎 Attach design system clicked');

      if (attachedDesignSystem) {
        // If already attached, detach
        detachDesignSystem();
      } else {
        // Show dropdown to select design system
        toggleDropdown();
      }
    });

    function toggleDropdown() {
      isDropdownOpen = !isDropdownOpen;
      const dropdown = document.getElementById('library-dropdown');
      const arrow = document.getElementById('dropdown-arrow');

      if (isDropdownOpen) {
        dropdown.classList.add('show');
        attachButton.classList.add('open');

        // Load libraries if not already loaded
        if (availableLibraries.length === 0 && !isLoadingLibraries) {
          loadDesignSystems();
        }
      } else {
        dropdown.classList.remove('show');
        attachButton.classList.remove('open');
      }
    }

    function closeDropdown() {
      isDropdownOpen = false;
      const dropdown = document.getElementById('library-dropdown');
      dropdown.classList.remove('show');
      attachButton.classList.remove('open');
    }

    function loadDesignSystems() {
      isLoadingLibraries = true;
      const dropdown = document.getElementById('library-dropdown');
      dropdown.innerHTML = '<div class="library-item loading">Loading design systems...</div>';

      // Request libraries from the plugin
      parent.postMessage({
        pluginMessage: {
          type: 'get-libraries'
        }
      }, '*');
    }

    function populateDropdown(libraries) {
      const dropdown = document.getElementById('library-dropdown');
      dropdown.innerHTML = '';

      if (libraries.length === 0) {
        dropdown.innerHTML = '<div class="library-item no-libraries">No design systems found</div>';
        return;
      }

      libraries.forEach(library => {
        const item = document.createElement('div');
        item.className = 'library-item';
        item.innerHTML = `
          <span class="library-name">${library.name}</span>
          <span class="library-type">${library.source || 'Library'}</span>
        `;

        item.addEventListener('click', () => {
          selectDesignSystem(library);
        });

        dropdown.appendChild(item);
      });
    }

    function selectDesignSystem(library) {
      console.log('📎 Selected design system:', library.name);
      attachedDesignSystem = library;

      // Don't update button state yet - wait for validation check
      // The button will only update to "attached" if validation is possible

      // Close dropdown
      closeDropdown();

      // Update UI state
      updateUI();

      // Notify plugin
      parent.postMessage({
        pluginMessage: {
          type: 'attach-design-system',
          libraryId: library.id
        }
      }, '*');
    }

    function detachDesignSystem() {
      console.log('📎 Detaching design system');
      attachedDesignSystem = null;

      // Update UI
      document.getElementById('attach-text').textContent = 'Attach Design System';
      attachButton.classList.remove('attached');

      // Hide validation options
      document.getElementById('validation-options').style.display = 'none';

      // Update UI state
      updateUI();

      // Notify plugin
      parent.postMessage({
        pluginMessage: {
          type: 'detach-design-system'
        }
      }, '*');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!attachButton.contains(e.target) && !document.getElementById('library-dropdown').contains(e.target)) {
        closeDropdown();
      }
    });

    // Removed runButton event listener - focusing only on design system attachment

    backButton?.addEventListener('click', () => {
      console.log('← Back to form clicked');
      showFormView();
      parent.postMessage({ pluginMessage: { type: 'show-form-view' } }, '*');
    });

    expandButton?.addEventListener('click', () => {
      console.log('🔄 Expand clicked');
      showFormView();
      parent.postMessage({ pluginMessage: { type: 'show-form-view' } }, '*');
    });

    // Documentation functionality
    document.getElementById('documentation-link')?.addEventListener('click', () => {
      console.log('📖 Documentation clicked');
      showDocumentationView();
      parent.postMessage({ pluginMessage: { type: 'show-documentation-view' } }, '*');
    });

    document.getElementById('documentation-back-button')?.addEventListener('click', () => {
      console.log('← Documentation back clicked');
      showFormView();
      parent.postMessage({ pluginMessage: { type: 'show-form-view' } }, '*');
    });

    // Function to update Run Validation button state
    function updateRunValidationButton() {
      const runValidationButton = document.getElementById('run-validation');
      const validateTextStyles = document.getElementById('validate-text-styles')?.checked || false;
      const validateSpacing = document.getElementById('validate-spacing')?.checked || false;

      const hasSelection = validateTextStyles || validateSpacing;

      if (runValidationButton) {
        runValidationButton.disabled = !hasSelection;
        if (hasSelection) {
          runValidationButton.classList.remove('disabled');
        } else {
          runValidationButton.classList.add('disabled');
        }
      }
    }

    // Add event listeners to checkboxes to update button state
    document.getElementById('validate-text-styles')?.addEventListener('change', updateRunValidationButton);
    document.getElementById('validate-spacing')?.addEventListener('change', updateRunValidationButton);

    // Run validation button
    const runValidationButton = document.getElementById('run-validation');
    runValidationButton?.addEventListener('click', () => {
      console.log('▶ Run validation clicked');

      // Get selected validation options
      const validateTextStyles = document.getElementById('validate-text-styles').checked;
      const validateSpacing = document.getElementById('validate-spacing').checked;

      if (!validateTextStyles && !validateSpacing) {
        alert('Please select at least one validation option.');
        return;
      }

      // Send validation request to plugin
      parent.postMessage({
        pluginMessage: {
          type: 'run-validation',
          options: {
            textStyles: validateTextStyles,
            spacing: validateSpacing
          }
        }
      }, '*');

      // Switch to results view
      showResultsView();
      parent.postMessage({ pluginMessage: { type: 'show-results-view' } }, '*');
    });

    // Initialize button state
    updateRunValidationButton();

    // Header collapse toggle
    collapseBtn?.addEventListener('click', () => {
      console.log('🔄 Collapse toggle clicked');
      parent.postMessage({ pluginMessage: { type: 'toggle-collapse' } }, '*');
    });



    // Function to fetch all published styles from a library via REST API
    async function fetchLibraryStyles(fileKey, libraryName) {
      console.log(`🚀🚀🚀 FETCHING ALL PUBLISHED STYLES FROM ${libraryName} 🚀🚀🚀`);
      console.log(`📁 File Key: ${fileKey}`);

      try {
        // Note: This requires a Figma access token
        // For demo purposes, we'll show what the response would look like
        console.log(`\n📡 REST API CALL:`);
        console.log(`   URL: https://api.figma.com/v1/files/${fileKey}`);
        console.log(`   Method: GET`);
        console.log(`   Headers: { 'Authorization': 'Bearer YOUR_FIGMA_ACCESS_TOKEN' }`);

        console.log(`\n⚠️ NOTE: This demo cannot make actual HTTP requests due to browser security.`);
        console.log(`   To see all published styles, you would need to:`);
        console.log(`   1. Get a Figma access token from https://www.figma.com/developers/api`);
        console.log(`   2. Make the API call from your server or a tool like Postman`);
        console.log(`   3. Filter response.styles for style_type === 'TEXT'`);

        console.log(`\n📋 EXPECTED RESPONSE STRUCTURE:`);
        console.log(`{`);
        console.log(`  "styles": [`);
        console.log(`    {`);
        console.log(`      "key": "style_key_here",`);
        console.log(`      "name": "Display/Large",`);
        console.log(`      "description": "Large display text",`);
        console.log(`      "style_type": "TEXT",`);
        console.log(`      "created_at": "2024-01-01T00:00:00Z",`);
        console.log(`      "updated_at": "2024-01-01T00:00:00Z"`);
        console.log(`    },`);
        console.log(`    {`);
        console.log(`      "key": "another_style_key",`);
        console.log(`      "name": "Display/Medium",`);
        console.log(`      "description": "Medium display text",`);
        console.log(`      "style_type": "TEXT"`);
        console.log(`    }`);
        console.log(`    // ... more styles`);
        console.log(`  ]`);
        console.log(`}`);

        console.log(`\n💡 JAVASCRIPT EXAMPLE TO FETCH ALL STYLES:`);
        console.log(`const response = await fetch('https://api.figma.com/v1/files/${fileKey}', {`);
        console.log(`  headers: { 'Authorization': 'Bearer YOUR_ACCESS_TOKEN' }`);
        console.log(`});`);
        console.log(`const data = await response.json();`);
        console.log(`const textStyles = data.styles.filter(s => s.style_type === 'TEXT');`);
        console.log(`console.log('All published text styles:', textStyles);`);

        // Simulate what the response might contain based on complete Blueprint Atoms library
        console.log(`\n🎯 SIMULATED RESPONSE (based on complete Blueprint Atoms library):`);
        const simulatedStyles = [
          // Display Family (2 Large variants visible in image)
          { key: `${fileKey}:700`, name: 'Display/Large', style_type: 'TEXT', description: 'Large display text (57/64)' },
          { key: `${fileKey}:701`, name: 'Display/Large', style_type: 'TEXT', description: 'Large display text variant (57/64)' },
          { key: `${fileKey}:775`, name: 'Display/Medium', style_type: 'TEXT', description: 'Medium display text (45/52)' },
          { key: `${fileKey}:782`, name: 'Display/Small', style_type: 'TEXT', description: 'Small display text (36/44)' },

          // Headline Family
          { key: `${fileKey}:800`, name: 'Headline/Large', style_type: 'TEXT', description: 'Large headline text (32/40)' },
          { key: `${fileKey}:801`, name: 'Headline/Medium', style_type: 'TEXT', description: 'Medium headline text (28/36)' },
          { key: `${fileKey}:802`, name: 'Headline/Small', style_type: 'TEXT', description: 'Small headline text (24/32)' },

          // Title Family
          { key: `${fileKey}:810`, name: 'Title/Large', style_type: 'TEXT', description: 'Large title text (22/28)' },
          { key: `${fileKey}:811`, name: 'Title/Medium', style_type: 'TEXT', description: 'Medium title text (16/24)' },
          { key: `${fileKey}:812`, name: 'Title/Small', style_type: 'TEXT', description: 'Small title text (14/20)' },

          // Body Family
          { key: `${fileKey}:820`, name: 'Body/Large', style_type: 'TEXT', description: 'Large body text (16/24)' },
          { key: `${fileKey}:821`, name: 'Body/Medium', style_type: 'TEXT', description: 'Medium body text (14/20)' },
          { key: `${fileKey}:822`, name: 'Body/Small', style_type: 'TEXT', description: 'Small body text (12/16)' },

          // Label Family
          { key: `${fileKey}:830`, name: 'Label/Large', style_type: 'TEXT', description: 'Large label text (14/20)' },
          { key: `${fileKey}:831`, name: 'Label/Medium', style_type: 'TEXT', description: 'Medium label text (12/16)' },
          { key: `${fileKey}:832`, name: 'Label/Small', style_type: 'TEXT', description: 'Small label text (11/16)' }
        ];

        console.log(`📊 SIMULATED: Found ${simulatedStyles.length} published text styles:`);
        simulatedStyles.forEach((style, index) => {
          console.log(`   ${index + 1}. "${style.name}" (Key: ${style.key})`);
          console.log(`      📝 ${style.description}`);
        });

        console.log(`\n✅✅✅ LIBRARY STYLES FETCH COMPLETE ✅✅✅`);

      } catch (error) {
        console.error('❌ Error fetching library styles:', error);
      }
    }

    // Listen for messages from plugin
    window.addEventListener('message', (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      console.log('📨 UI received message:', msg);

      if (msg.type === 'ui-state') {
        if (msg.collapsed) {
          showCollapsedView();
        } else {
          // Return to previous view or default to form
          if (currentView === 'collapsed') {
            showFormView();
          }
        }
        if (collapseBtn) {
          collapseBtn.textContent = msg.collapsed ? '▸' : '▾';
        }
      }

      if (msg.type === 'view-mode') {
        if (msg.mode === 'form') {
          showFormView();
        } else if (msg.mode === 'results') {
          showResultsView();
        }
      }

      if (msg.type === 'libraries-response') {
        console.log('📚 Received libraries:', msg.libraries);
        isLoadingLibraries = false;
        availableLibraries = msg.libraries || [];
        populateDropdown(availableLibraries);
      }

      if (msg.type === 'design-system-attached') {
        console.log('✅ Design system attached:', msg.library);
        // Update UI to reflect successful attachment
        document.getElementById('attach-text').textContent = `${msg.library.name} Attached`;
        attachButton.classList.add('attached');

        // Update counts in validation options
        if (msg.counts) {
          document.getElementById('text-styles-count').textContent = `${msg.counts.textStyles} Styles Available`;
          document.getElementById('spacing-count').textContent = `${msg.counts.spacing} Variables Available`;

          // Show "View Tokens" links if there are tokens available
          if (msg.counts.textStyles > 0) {
            document.getElementById('view-text-styles').style.display = 'inline';
          }
          if (msg.counts.spacing > 0) {
            document.getElementById('view-spacing').style.display = 'inline';
          }
        }

        // Show validation options
        document.getElementById('validation-options').style.display = 'block';
      }

      if (msg.type === 'design-system-error') {
        console.log('❌ Design system error:', msg.error);
        // Show error message
        alert('Error: ' + msg.error);
      }

      if (msg.type === 'no-design-system-usage') {
        console.log('⚠️ No design system usage found:', msg.message);
        // Alert user that validation isn't possible without usage
        alert(`⚠️ Validation Not Possible\n\n${msg.message}\n\nTip: Select a text field and apply at least 1 text style from "${msg.libraryName}" using the text style panel, then try attaching the design system again.`);
      }

      if (msg.type === 'tokens-response') {
        console.log('📋 Received tokens:', msg);
        populateTokensPanel(msg.tokens, msg.tokenType);
      }

      if (msg.type === 'documentation-content') {
        console.log('📖 Received documentation content');
        const content = document.getElementById('documentationContent');
        if (content) {
          content.innerHTML = msg.content;
        }
      }

      if (msg.type === 'validation-results') {
        console.log('📊 Received validation results:', msg);
        availableTokens = msg.tokens; // Store the actual tokens
        displayValidationResults(msg.issues, msg.summary);

        // Removed run button reset - not needed
      }

      if (msg.type === 'fetch-library-styles') {
        console.log('📡 Fetching library styles via REST API:', msg);
        fetchLibraryStyles(msg.fileKey, msg.libraryName);
      }

      if (msg.type === 'validation-error') {
        console.log('❌ Validation error:', msg.error);
        alert('Validation Error: ' + msg.error);

        // Go back to form
        showFormView();
        parent.postMessage({ pluginMessage: { type: 'show-form-view' } }, '*');
      }

      if (msg.type === 'text-styles-analyzed') {
        console.log('📝 Text styles analyzed:', msg);

        // Show a brief notification about the analysis
        const styleCount = msg.stylePatterns.length;
        const libraryCount = msg.usage.libraryStyles;

        if (styleCount > 0) {
          console.log(`✨ Found ${styleCount} text style patterns in use`);
          console.log(`📚 ${libraryCount} elements using library styles`);

          // Could show a toast notification here in the future
          // For now, just log the success
        }
      }
    });

    // Results display function
    function displayValidationResults(issues, summary) {
      console.log('📊 Displaying validation results:', issues.length, 'issues');

      // Results count removed from header

      // Update results content
      const resultsContent = document.getElementById('results-content');
      if (resultsContent) {
        if (issues.length === 0) {
          resultsContent.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #4CAF50;">
              <div style="font-size: 48px; margin-bottom: 16px;">✅</div>
              <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Great job!</div>
              <div style="font-size: 14px; color: #666;">No token validation issues found in your design.</div>
            </div>
          `;
        } else {
          // Create the new layout matching the design
          let html = `
            <!-- Issues Found Header -->
            <div style="background: #fff3e0; border: 1px solid #ffcc02; border-radius: 8px; padding: 16px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
              <div style="color: #f57c00; font-size: 20px;">⚠️</div>
              <div>
                <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 2px;">Issues Found</div>
                <div style="font-size: 14px; color: #666;">${summary.totalIssues} issues in ${issues.length} nodes (Current Page)</div>
              </div>
            </div>

            <!-- Issue Cards -->
            <div style="display: flex; flex-direction: column; gap: 16px;">
          `;

          // Create issue cards
          issues.forEach((issue, index) => {
            const typeLabels = {
              'spacing': 'spacing',
              'corner-radius': 'border radius',
              'font-size': 'font size',
              'font-color': 'color'
            };

            const typeLabel = typeLabels[issue.type] || issue.type;

            // Generate suggested tokens for dropdown
            const suggestedTokens = getSuggestedTokensForIssue(issue);

            html += `
              <div style="background: white; border-radius: 8px; border-left: 4px solid #ff9800; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <!-- Issue Header -->
                <div style="margin-bottom: 12px;">
                  <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 4px;">
                    ${issue.nodeName}
                  </div>
                  <div style="font-size: 14px; color: #666;">
                    Using hardcoded ${typeLabel}: ${issue.currentValue}${typeof issue.currentValue === 'number' ? 'px' : ''}
                  </div>
                </div>

                <!-- Best Match Badge -->
                <div style="margin-bottom: 12px;">
                  <span style="display: inline-block; background: #E3F2FD; color: #007AFF; font-size: 12px; font-weight: 500; padding: 4px 12px; border-radius: 6px;">Best Match</span>
                </div>

                <!-- Dropdown and Action Buttons in one row -->
                <div style="display: flex; align-items: center; gap: 8px;">
                  <select style="min-width: 200px; max-width: 300px; padding: 8px 12px; border: 2px solid #007AFF; border-radius: 6px; font-size: 14px; background: white;" 
                          id="token-select-${index}">
                    ${suggestedTokens.map(token => {
              const displayValue = typeof token.value === 'number' ? `${token.value}px` : token.value;
              return `<option value="${token.id}">${token.name} - ${displayValue}</option>`;
            }).join('')}
                  </select>
                  <button style="display: flex; align-items: center; justify-content: center; padding: 8px 12px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; cursor: pointer; color: #333;" 
                          onclick="viewIssueNode('${issue.nodeId}')">
                    View
                  </button>
                  <button style="display: flex; align-items: center; gap: 6px; padding: 8px 16px; background: #007AFF; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; color: white; font-weight: 500;" 
                          onclick="updateIssueNode('${issue.nodeId}', ${index})">
                    Update
                  </button>
                  <button style="display: flex; align-items: center; justify-content: center; padding: 8px 12px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; cursor: pointer; color: #333;" 
                          onclick="ignoreIssue('${issue.nodeId}', ${index})">
                    Ignore
                  </button>
                </div>
              </div>
            `;
          });

          html += '</div>';
          resultsContent.innerHTML = html;
        }
      }
    }

    // Helper function to get suggested tokens for an issue
    function getSuggestedTokensForIssue(issue) {
      if (!availableTokens) {
        console.log('⚠️ No tokens available yet');
        return [];
      }

      console.log('🎨 Getting suggested tokens for issue type:', issue.type);
      console.log('🎨 Available tokens:', availableTokens);

      // Map issue types to token categories
      const tokenTypeMap = {
        'spacing': 'spacings',
        'corner-radius': 'cornerRadius',
        'font-size': 'fontSize',
        'font-color': 'fontColor'
      };

      const tokenCategory = tokenTypeMap[issue.type];
      if (!tokenCategory || !availableTokens[tokenCategory]) {
        console.log('⚠️ No tokens found for category:', tokenCategory);
        return [];
      }

      const tokens = availableTokens[tokenCategory];
      console.log(`🎨 Found ${tokens.length} tokens for ${issue.type}:`, tokens);

      // Sort tokens by how close they are to the current value (if numeric)
      if (typeof issue.currentValue === 'number') {
        return tokens.sort((a, b) => {
          const diffA = Math.abs(a.value - issue.currentValue);
          const diffB = Math.abs(b.value - issue.currentValue);
          return diffA - diffB;
        });
      }

      return tokens;
    }

    // Action button functions
    window.viewIssueNode = function (nodeId) {
      console.log('👁️ Viewing node:', nodeId);
      parent.postMessage({
        pluginMessage: {
          type: 'select-node',
          nodeId: nodeId
        }
      }, '*');
    };

    window.updateIssueNode = function (nodeId, issueIndex) {
      console.log('🔄 Updating node:', nodeId, 'with issue index:', issueIndex);

      // Get the selected token from the dropdown
      const selectElement = document.getElementById(`token-select-${issueIndex}`);
      const selectedTokenId = selectElement ? selectElement.value : null;

      if (selectedTokenId) {
        parent.postMessage({
          pluginMessage: {
            type: 'update-node-token',
            nodeId: nodeId,
            tokenId: selectedTokenId,
            issueIndex: issueIndex
          }
        }, '*');
      } else {
        console.log('❌ No token selected for update');
      }
    };

    window.ignoreIssue = function (nodeId, issueIndex) {
      console.log('✕ Ignoring issue for node:', nodeId, 'issue index:', issueIndex);

      // Remove the issue card from the UI
      const issueCards = document.querySelectorAll('[style*="border-left: 4px solid #ff9800"]');
      if (issueCards[issueIndex]) {
        issueCards[issueIndex].style.opacity = '0.5';
        issueCards[issueIndex].style.pointerEvents = 'none';

        // Add "Ignored" label
        const header = issueCards[issueIndex].querySelector('[style*="font-size: 16px"]');
        if (header && !header.textContent.includes('(Ignored)')) {
          header.textContent += ' (Ignored)';
        }
      }

      parent.postMessage({
        pluginMessage: {
          type: 'ignore-issue',
          nodeId: nodeId,
          issueIndex: issueIndex
        }
      }, '*');
    };

    // Legacy function for backward compatibility
    window.selectIssueNode = function (nodeId) {
      console.log('🎯 Selecting node:', nodeId);
      window.viewIssueNode(nodeId);
    };

    // Tokens Panel Management
    let currentTokensData = null;

    function showTokensPanel(tokenType) {
      console.log('📋 Showing tokens panel for:', tokenType);

      const panel = document.getElementById('tokensPanel');
      const title = document.getElementById('tokensPanelTitle');
      const content = document.getElementById('tokensPanelContent');

      // Set title based on token type
      if (tokenType === 'text-styles') {
        title.textContent = 'Text Styles';
      } else if (tokenType === 'spacing') {
        title.textContent = 'Spacing Tokens';
      }

      // Request tokens data from plugin
      parent.postMessage({
        pluginMessage: {
          type: 'get-tokens',
          tokenType: tokenType
        }
      }, '*');

      // Show the panel
      panel.classList.add('show');
    }

    function hideTokensPanel() {
      console.log('📋 Hiding tokens panel');
      const panel = document.getElementById('tokensPanel');
      panel.classList.remove('show');
    }

    function populateTokensPanel(tokens, tokenType) {
      console.log('📋 Populating tokens panel with:', tokens);
      const content = document.getElementById('tokensPanelContent');

      if (!tokens || tokens.length === 0) {
        content.innerHTML = `
          <div class="tokens-empty">
            <div class="tokens-empty-icon">📋</div>
            <div>No ${tokenType === 'text-styles' ? 'text styles' : 'spacing variables'} available</div>
          </div>
        `;
        return;
      }

      let html = '';

      if (tokenType === 'text-styles') {
        // Group text styles by family (Display, Headline, Title, etc.)
        const groupedStyles = {};

        tokens.forEach(token => {
          const parts = token.name.split('/');
          const family = parts[0] || 'Other';

          if (!groupedStyles[family]) {
            groupedStyles[family] = [];
          }

          groupedStyles[family].push(token);
        });

        // Create sections with headers and original card design
        Object.keys(groupedStyles).sort().forEach(family => {
          html += `
            <div class="token-category">
              <div class="token-category-header">${family}</div>
          `;

          groupedStyles[family].forEach(token => {
            const parts = token.name.split('/');
            const variant = parts[1] || token.name; // Extract just the variant (Large, Medium, Small)

            html += `
              <div class="token-item">
                <div class="token-info">
                  <div class="token-name">${variant}</div>
                  <div class="token-description">${token.description || 'Text style from design system'}</div>
                </div>
                <div class="token-value">${token.fontSize}px</div>
              </div>
            `;
          });

          html += `</div>`;
        });
      } else if (tokenType === 'spacing') {
        tokens.forEach(token => {
          html += `
            <div class="token-item">
              <div class="token-info">
                <div class="token-name">${token.name}</div>
                <div class="token-description">${token.description || 'Spacing variable from design system'}</div>
              </div>
              <div class="token-value">${token.value}${typeof token.value === 'number' ? 'px' : ''}</div>
            </div>
          `;
        });
      }

      content.innerHTML = html;
    }



    // Tokens panel event listeners
    document.getElementById('tokensBackButton')?.addEventListener('click', () => {
      hideTokensPanel();
    });

    // Global function for onclick handlers
    window.showTokensPanel = showTokensPanel;

    // Initial setup
    updateUI();
    showFormView();

    console.log('✅ UI SCRIPT LOADED');
  </script>
</body>

</html>